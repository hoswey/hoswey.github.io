<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="程序员，川流不息">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="程序员，川流不息">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="程序员，川流不息">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>程序员，川流不息</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">程序员，川流不息</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/25/how-time-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/25/how-time-work/" itemprop="url">Linux如何获取时间</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-25T09:42:00+08:00">
                2020-08-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/25/how-time-work/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/08/25/how-time-work/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>这几天和盛哥聊到了系统调用的开销，有些是io,有些是内存，突然提到了尽管像<strong>获取时间</strong>这种调用，有些对性能要求极高的系统也会做针对性优化。<br>连”获取时间“都要优化，nginx不就是这么处理么？为什么要这样处理?时间这个基础性的信息底层到底是怎样呢，而高级语言Java/C这些获取时间的方式又是怎么和底层交互的？这个问题激起了我极大的兴趣，希望能通过对“时间”的技术细节做层梳理和探索，加深对操作系统以及Java语言的理解。以生产环境服务器ubuntu为例，设定以下目标</p>
<ul>
<li>C/Java是如何获取当前时间</li>
<li>Linux是怎么维护和衡量时间</li>
<li>java获取当前时间的原理，是否存在性能问题</li>
<li>nginx对获取时间做了什么优化</li>
</ul>
<h2 id="C-Java是如何获取当前时间"><a href="#C-Java是如何获取当前时间" class="headerlink" title="C/Java是如何获取当前时间"></a>C/Java是如何获取当前时间</h2><p>从<a href="https://man7.org/tlpi/" target="_blank" rel="noopener">The Linux Programming Interface
</a> 上看，获取时间最常用的函数是<strong> <a href="https://man7.org/linux/man-pages/man2/gettimeofday.2.html" target="_blank" rel="noopener">gettimeofday</a></strong>，常见的中间件也是用该函数么？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gettimeofday</span><span class="params">(struct timeval *tv, struct timezone *tz)</span></span>;</span><br><span class="line">												Returns <span class="number">0</span> on success, <span class="keyword">or</span> –<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>扫了下redis的命令，发现redis有个<a href="https://redis.io/commands/time" target="_blank" rel="noopener">time</a> command. 调用该command能够返回当前服务器的时间戳，从<a href="https://github.com/redis/redis/blob/7bf665f125a4771db095c83a7ad6ed46692cd314/src/server.c#L3857" target="_blank" rel="noopener">redis源码</a><br>)上看，redis也是调用了<strong>gettimeofday</strong>获取当前的时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* gettimeofday() can only fail if &amp;tv is a bad address so we</span></span><br><span class="line"><span class="comment">     * don't check for errors. */</span></span><br><span class="line">    gettimeofday(&amp;tv,<span class="literal">NULL</span>);</span><br><span class="line">    addReplyArrayLen(c,<span class="number">2</span>);</span><br><span class="line">    addReplyBulkLongLong(c,tv.tv_sec);</span><br><span class="line">    addReplyBulkLongLong(c,tv.tv_usec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>Java呢，是怎么获取时间的, System.currentTimeMillis()是java中获取当前时间的基础，java.lang.Date对象的构造也是通过调用System.currentTimeMillis()获取当前时间戳进行初始化。</p>
<p><a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/System.java#l353" target="_blank" rel="noopener">System源码</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the current time in milliseconds.  Note that</span></span><br><span class="line"><span class="comment"> * while the unit of time of the return value is a millisecond,</span></span><br><span class="line"><span class="comment"> * the granularity of the value depends on the underlying</span></span><br><span class="line"><span class="comment"> * operating system and may be larger.  For example, many</span></span><br><span class="line"><span class="comment"> * operating systems measure time in units of tens of</span></span><br><span class="line"><span class="comment"> * milliseconds.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; See the description of the class &lt;code&gt;Date&lt;/code&gt; for</span></span><br><span class="line"><span class="comment"> * a discussion of slight discrepancies that may arise between</span></span><br><span class="line"><span class="comment"> * "computer time" and coordinated universal time (UTC).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  the difference, measured in milliseconds, between</span></span><br><span class="line"><span class="comment"> *          the current time and midnight, January 1, 1970 UTC.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span>     java.util.Date</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">currentTimeMillis</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>好吧，该方法是一个native方法，那就只能继续往jvm源码上看,从jvm源码上看，java获取时间戳最终也是通过gettimeofday获取,殊途同归。</p>
<p><a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/os/linux/vm/os_linux.cpp#l1362" target="_blank" rel="noopener">jvm源码os_linux.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jlong os::javaTimeMillis() &#123;</span><br><span class="line">  timeval time;</span><br><span class="line">  <span class="keyword">int</span> status = gettimeofday(&amp;time, <span class="literal">NULL</span>);</span><br><span class="line">  assert(status != <span class="number">-1</span>, <span class="string">"linux error"</span>);</span><br><span class="line">  <span class="keyword">return</span> jlong(time.tv_sec) * <span class="number">1000</span>  +  jlong(time.tv_usec / <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好，继续往下一个问题</p>
<h2 id="Linux是怎么维护和衡量时间"><a href="#Linux是怎么维护和衡量时间" class="headerlink" title="Linux是怎么维护和衡量时间"></a>Linux是怎么维护和衡量时间</h2><p>总的来说，现代操作系统主板上会有个<a href="https://en.wikipedia.org/wiki/Real-time_clock" target="_blank" rel="noopener">Real Time Clock</a>,记录着当前的时间，通过主板上的电池<a href="https://en.wikipedia.org/wiki/Nonvolatile_BIOS_memory#CMOS_battery" target="_blank" rel="noopener">CMOS Battery</a>维持,假如电池没电了,那我们启动后时间就会出现不正常的情况，通过api去获取时间当然的也会出现相应的问题问题。假如时间出现问题，可以通过手动或者自动的方式校准。  </p>
<p>服务器启动的时候就会读取当前时间，保存到kernel，记T1<br>同时启动<a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter" target="_blank" rel="noopener">TSC</a>,什么是TSC?简单来说就是一个64bit的寄存器，记录着服务器启动以来cpu的cycle,每个cycle的时间就是1/CPU频率，例如cpu 2GHZ, 那么就表示一个cycle的时间是0.5ns<br>所以获取当前时间的方式就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当前时间 = T1 + TSC * 0.5  //时间的精度为1ns</span><br></pre></td></tr></table></figure>
<p>除了TSC, Linux还有其他方式维护时间，但由于目前主流服务器上都是TSC,所以其他方式的不详述<br>如何查看当前服务器支持的时间源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/devices/system/clocksource/clocksource0/available_clocksource</span><br><span class="line">tsc hpet acpi_pm</span><br></pre></td></tr></table></figure>
<p>如何查看当前服务器使用的时间源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/devices/system/clocksource/clocksource0/current_clocksource</span><br><span class="line">tsc</span><br></pre></td></tr></table></figure>
<p>Linux最常用的获取时间的接口是<a href="https://man7.org/linux/man-pages/man2/gettimeofday.2.html" target="_blank" rel="noopener">gettimeofday</a>, 但除了该方法，Linux还提供了<a href="https://www.man7.org/linux/man-pages/man2/clock_gettime.2.html" target="_blank" rel="noopener">clock_gettime</a>,该api提供了多种获取时间的方式，这里需要注意的是，<a href="https://man7.org/linux/man-pages/man2/gettimeofday.2.html" target="_blank" rel="noopener">gettimeofday</a>最终也是调用了<a href="https://www.man7.org/linux/man-pages/man2/clock_gettime.2.html" target="_blank" rel="noopener">clock_gettime</a>就是指定了clockid clock_realtime的时间, 在新版本, linux提供多了一种clockid,<a href="https://lore.kernel.org/patchwork/patch/164350/" target="_blank" rel="noopener">CLOCK_REALTIME_COARSE</a>,从manual上看该clockid提供了了一种新的选择“need very fast, but not fine-grained timestamps”。  </p>
<p>需要注意的，对于clockid CLOCK_MONOTONIC,这里获取的是一个单调递增的计数器，不受系统时间修改的影响，这个java也会使用到，先记着:)</p>
<table>
<thead>
<tr>
<th>clockid</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CLOCK_REALTIME</td>
<td>System-wide  clock  that  measures  real (i.e., wall-clock) time.  Setting this clock requires appropriate privileges.  This clock is affected by discontinuous        jumps in the system time (e.g., if the system administrator manually changes the clock), and by the incremental adjustments performed by adjtime(3) and NTP.</td>
</tr>
<tr>
<td>CLOCK_REALTIME_COARSE</td>
<td>(since Linux 2.6.32; Linux-specific)        A faster but less precise version of CLOCK_REALTIME.  Use when you need very fast, but not fine-grained timestamps.</td>
</tr>
<tr>
<td>CLOCK_MONOTONIC</td>
<td>Clock that cannot be set and represents monotonic time since some unspecified starting point.  This clock is not affected by discontinuous jumps in the  system        time (e.g., if the system administrator manually changes the clock), but is affected by the incremental adjustments performed by adjtime(3) and NTP.</td>
</tr>
<tr>
<td>CLOCK_MONOTONIC_COARSE</td>
<td>(since Linux 2.6.32; Linux-specific)        A faster but less precise version of CLOCK_MONOTONIC.  Use when you need very fast, but not fine-grained timestamps.</td>
</tr>
<tr>
<td>CLOCK_MONOTONIC_RAW</td>
<td>(since Linux 2.6.28; Linux-specific)        Similar to CLOCK_MONOTONIC, but provides access to a raw hardware-based time that is not subject to NTP adjustments or the incremental adjustments performed by        adjtime(3).</td>
</tr>
<tr>
<td>CLOCK_BOOTTIME</td>
<td>(since Linux 2.6.39; Linux-specific)        Identical to CLOCK_MONOTONIC, except it also includes any time that the system is suspended.  This allows applications to get a suspend-aware  monotonic  clock        without having to deal with the complications of CLOCK_REALTIME, which may have discontinuities if the time is changed using settimeofday(2).</td>
</tr>
<tr>
<td>CLOCK_PROCESS_CPUTIME_ID</td>
<td>(since Linux 2.6.12)        Per-process CPU-time clock (measures CPU time consumed by all threads in the process).</td>
</tr>
<tr>
<td>CLOCK_THREAD_CPUTIME_ID</td>
<td>(since Linux 2.6.12)        Thread-specific CPU-time clock.</td>
</tr>
</tbody>
</table>
<p>接下来，我们就来对比各种clockid的性能。<br>可以参考<a href="https://stackoverflow.com/questions/6498972/faster-equivalent-of-gettimeofday/13096917#13096917" target="_blank" rel="noopener">StackOverflow</a>的这个回答，可以看出<br>CLOCK_REALTIME和CLOCK_REALTIME_COARSE的性能区别还是比较高，这样对于需要高性能但相对不精确的时间时还是可以选择CLOCK_REALTIME_COARSE的</p>
<blockquote>
<p>time (s) =&gt; 3 cycles<br>ftime (ms) =&gt; 54 cycles<br>gettimeofday (us) =&gt; 42 cycles<br>clock_gettime (ns) =&gt; 9 cycles (CLOCK_MONOTONIC_COARSE)<br>clock_gettime (ns) =&gt; 9 cycles (CLOCK_REALTIME_COARSE)<br>clock_gettime (ns) =&gt; 42 cycles (CLOCK_MONOTONIC)<br>clock_gettime (ns) =&gt; 42 cycles (CLOCK_REALTIME)<br>clock_gettime (ns) =&gt; 173 cycles (CLOCK_MONOTONIC_RAW)<br>clock_gettime (ns) =&gt; 179 cycles (CLOCK_BOOTTIME)<br>clock_gettime (ns) =&gt; 349 cycles (CLOCK_THREAD_CPUTIME_ID)<br>clock_gettime (ns) =&gt; 370 cycles (CLOCK_PROCESS_CPUTIME_ID)<br>rdtsc (cycles) =&gt; 24 cycles  </p>
</blockquote>
<p>好吧，上面只是别人的一些经验，直接在服务器上跑<a href="https://github.com/btorpey/clocks" target="_blank" rel="noopener">测试</a>,可以看出CLOCK_REALTIME平均执行16.15ns, coarse版本的api执行的时间为0， 说明执行的时间小于 1/3.4 ns，好了，至此已经知道Linux常用获取时间的api的效率了</p>
<p>服务器CPU为 3.4GHz</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>min</th>
<th>max</th>
<th>avg</th>
<th>median</th>
<th>stdev</th>
</tr>
</thead>
<tbody>
<tr>
<td>CLOCK_REALTIME</td>
<td>14.00</td>
<td>18.00</td>
<td>16.15</td>
<td>16.00</td>
<td>1.24</td>
</tr>
<tr>
<td>CLOCK_REALTIME_COARSE</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
</tr>
<tr>
<td>CLOCK_MONOTONIC</td>
<td>14.00</td>
<td>19.00</td>
<td>15.88</td>
<td>16.50</td>
<td>1.23</td>
</tr>
<tr>
<td>CLOCK_MONOTONIC_RAW</td>
<td>63.00</td>
<td>67.00</td>
<td>64.87</td>
<td>65.00</td>
<td>1.23</td>
</tr>
<tr>
<td>CLOCK_MONOTONIC_COARSE</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
</tr>
</tbody>
</table>
<h2 id="java获取当前时间的原理，是否存在性能问题"><a href="#java获取当前时间的原理，是否存在性能问题" class="headerlink" title="java获取当前时间的原理，是否存在性能问题"></a>java获取当前时间的原理，是否存在性能问题</h2><p>从上面已知， System.currentTimeMillis()最终调用是到了clock_realtime,该api执行时间大概16ns.<br>为什么java不用coarse版本的接口呢？从网上查了一轮资料，发现在2017年其实已经有人提了这个问题,具体问题可参考<a href="http://localhost:4000/admin/#/posts/cke9ack1f000400vj079om36h" target="_blank" rel="noopener">Jdk Issue</a><br>简单的说，官方回复是，该执行时间目前不是瓶颈，coarse版本对于旧版本的操作系统不一定支持，需要进行各种兼容判断，会带来额外的性能开销。</p>
<h3 id="java其他时间函数-System-nanoTime"><a href="#java其他时间函数-System-nanoTime" class="headerlink" title="java其他时间函数- System.nanoTime()"></a>java其他时间函数- System.nanoTime()</h3><p>Java除了System.currentTimeMillis(),还有一个常用的获取时间api, System.nanoTime(). 这个方法容易望文生义，觉得就是返回当前时间戳的纳秒数。在服务器上执行以下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  System.out.println(System.currentTimeMillis());</span><br><span class="line">  System.out.println(System.nanoTime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1598924672863</span><br><span class="line">8616575473749327</span><br></pre></td></tr></table></figure>
<p>这个输出有点奇怪，假如nanoTime输出的是是距离epoch至今的纳秒数，那么理论上值应该是 System.currentTimeMillis() * 10的9次方</p>
<p>从<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/System.java#l356" target="_blank" rel="noopener">JDK注释</a>上看， “can only be used to measure elapsed time”, 注释说明了该api提供的是作用是度量elapsed time, 而非某个具体的时间，该返回的时间也不受系统时间（wall clock）修改影响，例如ntp的时间矫正或者人工调整时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the current value of the running Java Virtual Machine's</span></span><br><span class="line"><span class="comment">    * high-resolution time source, in nanoseconds.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This method can only be used to measure elapsed time and is</span></span><br><span class="line"><span class="comment">    * not related to any other notion of system or wall-clock time.</span></span><br><span class="line"><span class="comment">    * The value returned represents nanoseconds since some fixed but</span></span><br><span class="line"><span class="comment">    * arbitrary &lt;i&gt;origin&lt;/i&gt; time (perhaps in the future, so values</span></span><br><span class="line"><span class="comment">    * may be negative).  The same origin is used by all invocations of</span></span><br><span class="line"><span class="comment">    * this method in an instance of a Java virtual machine; other</span></span><br><span class="line"><span class="comment">    * virtual machine instances are likely to use a different origin.</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    * &lt;p&gt; For example, to measure how long some code takes to execute:</span></span><br><span class="line"><span class="comment">    *  &lt;pre&gt; &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">    * long startTime = System.nanoTime();</span></span><br><span class="line"><span class="comment">    * // ... the code being measured ...</span></span><br><span class="line"><span class="comment">    * long estimatedTime = System.nanoTime() - startTime;&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br></pre></td></tr></table></figure>
<p>那么nanoTime有什么应用场景呢，其实在jdk里面有些类也特意使用了nanoTime.<br>Java有个比较经典的问题，<strong>为什么使用ScheduledThreadPoolExecutor而非Timer</strong>.<br><a href="http://jcip.net/" target="_blank" rel="noopener">Java Concurrency in Practice
</a>里对比<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/Timer.java#l180" target="_blank" rel="noopener">Timer</a>和ScheduledThreadPoolExecutor提到以下</p>
<blockquote>
<p>Timer does have support for scheduling based on absolute, not relative time, so that tasks can be sensitive to changes in the system clock; ScheduledThreadPoolExecutor supports only relative time.</p>
</blockquote>
<p>这个的意思是对于Timer的定时任务，会受到系统时间的影响，为什么呢？<br>因为<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/Timer.java#l180" target="_blank" rel="noopener">Timer</a>计算执行时间是通过System.currentTimeMillis(), 该时间是绝对时间，修改了系统时间，该时间相应就产生了变化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(TimerTask task, <span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (delay &lt; <span class="number">0</span>)</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative delay."</span>);</span><br><span class="line"> sched(task, System.currentTimeMillis()+delay, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/concurrent/ScheduledThreadPoolExecutor.java#l496" target="_blank" rel="noopener">ScheduledThreadPoolExecutor</a>是通过nanoTime获取时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">triggerTime</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> now() +</span><br><span class="line">              ((delay &lt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>)) ? delay : overflowFree(delay));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">now</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> System.nanoTime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么nanoTime这个api获取的是什么时间？从jvm源码上看，对于支持supports_monotonic_clock该时间源的，获取的就是CLOCK_MONOTONIC这个时间，这个时间是单调递增， 不受系统时间影响，所以ScheduledThreadPoolExecutor使用该clock source会更加的合理。</p>
<p><a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/os/linux/vm/os_linux.cpp#l1453" target="_blank" rel="noopener">os_linux.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">jlong os::javaTimeNanos() &#123;</span><br><span class="line">  <span class="keyword">if</span> (Linux::supports_monotonic_clock()) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">tp</span>;</span></span><br><span class="line">    <span class="keyword">int</span> status = Linux::clock_gettime(CLOCK_MONOTONIC, &amp;tp);</span><br><span class="line">    assert(status == <span class="number">0</span>, <span class="string">"gettime error"</span>);</span><br><span class="line">    jlong result = jlong(tp.tv_sec) * (<span class="number">1000</span> * <span class="number">1000</span> * <span class="number">1000</span>) + jlong(tp.tv_nsec);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    timeval time;</span><br><span class="line">    <span class="keyword">int</span> status = gettimeofday(&amp;time, <span class="literal">NULL</span>);</span><br><span class="line">    assert(status != <span class="number">-1</span>, <span class="string">"linux error"</span>);</span><br><span class="line">    jlong usecs = jlong(time.tv_sec) * (<span class="number">1000</span> * <span class="number">1000</span>) + jlong(time.tv_usec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1000</span> * usecs;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nginx是如何做优化"><a href="#nginx是如何做优化" class="headerlink" title="nginx是如何做优化"></a>nginx是如何做优化</h2><p>简单说， nginx是通过时间缓存优化时间获取的效率，定时更新缓存，获取时间时从该缓存获取</p>
<p>待补充</p>
<h2 id="补充信息"><a href="#补充信息" class="headerlink" title="补充信息"></a>补充信息</h2><p>gettimeofday虽然是存在一定开销，但linux其实已经针对做了很多优化，其实在目前，连系统调用的开销也已经消除了，通过vsdo技术，待持续学习</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ol>
<li><a href="https://cs.stackexchange.com/questions/54933/how-do-computers-keep-track-of-time/54935#54935?newreg=a3c82ae7da40419fac87f267f2f76623" target="_blank" rel="noopener">how-do-computers-keep-track-of-time</a>  </li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/reference_guide/sect-posix_clocks#CLOCK_MONOTONIC_COARSE_and_CLOCK_REALTIME_COARSE" target="_blank" rel="noopener">select posix clocks</a></li>
<li><a href="https://stackoverflow.com/questions/6498972/faster-equivalent-of-gettimeofday" target="_blank" rel="noopener">fast equivalent of gettimeofday</a></li>
<li><a href="https://www.chromium.org/chromium-os/how-tos-and-troubleshooting/tsc-resynchronization" target="_blank" rel="noopener">HPET vs TSC</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/02/Tomcat对于http-keepalive的控制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/02/Tomcat对于http-keepalive的控制/" itemprop="url">Tomcat对于http keepalive的控制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-02T11:23:21+08:00">
                2019-08-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/02/Tomcat对于http-keepalive的控制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/02/Tomcat对于http-keepalive的控制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>项目网关和进程之间采用的是http连接，进程转发有时会出现跨机房的情况，所以通过http keepalive保持长连接是减少延迟的关键，但现实并非完全的长连接。</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>网关和进程间的请求已经明确了http头非close, 由于http版本是1.1， 所以只要值不是”close”,那么明确的就是需要keepalive.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connection:</span><br></pre></td></tr></table></figure>
<p>但现象是，从连接状态上看，还是出现了TIME_WAIT的情况，10.77.1.24是源地址，10.77.1.60:12003是目标服务，TIME_WAIT,就是服务端主动关闭了连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo netstat -apn |  grep <span class="string">"10.77.1.60:12003"</span></span><br><span class="line">tcp        0      0 10.77.1.24:35720        10.77.1.60:12003        TIME_WAIT   -               </span><br><span class="line">tcp        0      0 10.77.1.24:37130        10.77.1.60:12003        ESTABLISHED 20750/java      </span><br><span class="line">tcp        0      0 10.77.1.24:39472        10.77.1.60:12003        ESTABLISHED 20750/java      </span><br><span class="line">tcp        0      0 10.77.1.24:40880        10.77.1.60:12003        ESTABLISHED 20750/java      </span><br><span class="line">tcp        0      0 10.77.1.24:40962        10.77.1.60:12003        ESTABLISHED 20750/java</span><br></pre></td></tr></table></figure>
<h2 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h2><h3 id="通过tcpdump排查问题"><a href="#通过tcpdump排查问题" class="headerlink" title="通过tcpdump排查问题"></a>通过tcpdump排查问题</h3><p>通过在服务器上执行tcpdump, 抓包分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i any host 10.77.1.60 and port 12003</span><br></pre></td></tr></table></figure>
<img src="/2019/08/02/Tomcat对于http-keepalive的控制/ws1.jpg" title="example.jpg">
<p>发现一个现象</p>
<ol>
<li>每个连接处理一段时间总会关闭，都是客户端也就是网关主动发起的关闭，从上图看，带了Fin标志的包从客户端发往服务端。</li>
<li>连接持续的时间不等，有60s, 90s, 122s, 151s,都不一定是整数</li>
</ol>
<p>由于是客户端主动发起的关闭连接，那么排查方向主要从客户端入手，看下有无一些设置时长的判断的逻辑之类，浏览了相关源码，发现并无相关代码。</p>
<p>所以考虑到，会否是服务端发起关闭的请求，客户端被动接受而已。所以看了FIN包的上一个http响应，发现tomcat服务器响应了<strong>“Connection: close”</strong>的header.</p>
<img src="/2019/08/02/Tomcat对于http-keepalive的控制/ws2.jpg" title="example.jpg">
<p>所以连接的重用是控制在tomcat端，通常控制http keepalive的方式有</p>
<ol>
<li>连接idle time.</li>
<li>使用该连接请求的次数。</li>
</ol>
<p>很明显可以排除第一点，怀疑是第二点的原因。统计了几个有相同情况的情况，发现每个请求都是重用了100次，tomcat就响应了<strong>“Connection: close”</strong>.</p>
<h3 id="分析tomcat"><a href="#分析tomcat" class="headerlink" title="分析tomcat"></a>分析tomcat</h3><p><a href="https://tomcat.apache.org/tomcat-8.5-doc/config/http.html#HTTP/2_Support" target="_blank" rel="noopener">Keepalive配置项</a></p>
<p><strong>maxKeepAliveRequests</strong></p>
<blockquote>
<p>The maximum number of HTTP requests which can be pipelined until the connection is closed by the server. Setting this attribute to 1 will disable HTTP/1.0 keep-alive, as well as HTTP/1.1 keep-alive and pipelining. Setting this to -1 will allow an unlimited amount of pipelined or keep-alive HTTP requests. If not specified, this attribute is set to 100.</p>
</blockquote>
<p>checkout tomcat源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span>  https://github.com/apache/tomcat.git </span><br><span class="line">//checkout项目使用到的版本8.5.31</span><br><span class="line">git checkout 18fac60288</span><br></pre></td></tr></table></figure>
<p>浏览处理http响应的代码，截取部分源码</p>
<p>Http11Processor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">service</span><span class="params">(SocketWrapperBase&lt;?&gt; socketWrapper)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</span><br><span class="line">	    keepAlive = <span class="keyword">false</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">	        socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">	    keepAlive = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">prepareResponse</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!keepAlive) &#123;</span><br><span class="line">	    <span class="comment">// Avoid adding the close header twice</span></span><br><span class="line">	    <span class="keyword">if</span> (!connectionClosePresent) &#123;</span><br><span class="line">	        headers.addValue(Constants.CONNECTION).setString(</span><br><span class="line">	                Constants.CLOSE);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!http11 &amp;&amp; !getErrorState().isError()) &#123;</span><br><span class="line">	    headers.addValue(Constants.CONNECTION).setString(Constants.KEEPALIVE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>tomcat作为服务端，通过maxKeepAliveRequests参数控制keepalive连接数的最大支持的数量，默认值为100.</li>
<li>除了maxKeepAliveRequests这个参数，tomcat还提供keepAliveTimeout，控制连接空闲的时间，默认是20秒。</li>
<li>这两个控制正对应着http1.1规范对于keepalive的定义。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/23/浅谈Java中的TCP超时/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/23/浅谈Java中的TCP超时/" itemprop="url">浅谈Java中的TCP超时</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-23T10:48:44+08:00">
                2019-07-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/23/浅谈Java中的TCP超时/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/23/浅谈Java中的TCP超时/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在远程调用的世界里，Timeout的情况非常常见，几乎每段时间就会听到几个同事关于Timeout各种情况的讨论，偶尔的会出现不同开发语言间的同事的讨论，例如read timeout, 语言的隔阂使得大家讨论的都不知道是否是同一回事。</p>
<p>对于Java，各种远程调用，http,hessian,dubbo什么的，抛个timeout异常也是常见的事情，timeout是什么，一般追追源码，追到最后发现是个native方法，看着javadoc, 了解得不甚透彻。 所以本文尽量从Java到操作系统层面尝试说明常见的各种Timeout。</p>
<h2 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h2><h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p>对于Java开发来说，最常见的异常莫过于SocketTimeoutException，从异常日志，一般会有两种情况</p>
<ul>
<li>connect timed out</li>
<li>read timed out</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.net.SocketTimeoutException: connect timed out</span><br><span class="line">        at java.net.PlainSocketImpl.socketConnect(Native Method)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:<span class="number">345</span>)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:<span class="number">206</span>)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:<span class="number">188</span>)</span><br><span class="line">        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:<span class="number">392</span>)</span><br><span class="line">        at java.net.Socket.connect(Socket.java:<span class="number">589</span>)</span><br><span class="line"></span><br><span class="line">java.net.SocketTimeoutException: Read timed out</span><br><span class="line">        at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">        at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">170</span>)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</span><br></pre></td></tr></table></figure>
<h3 id="原理-connect-timed-out"><a href="#原理-connect-timed-out" class="headerlink" title="原理 connect timed out"></a>原理 connect timed out</h3><p>“connect timed out”从字面上看就是连接的超时时间，那么超时时间是怎么控制的？</p>
<h4 id="java-net-Socket"><a href="#java-net-Socket" class="headerlink" title="java.net.Socket"></a>java.net.Socket</h4><img src="http://www.plantuml.com/plantuml/svg/umhEJyvEBL7GjLE0iAmKalFpybAJIpHACdDJyqjBDBbGbHH3k9wv1JbmjLne4Y2rZad59KM9oIK1EOcPUTZqu52WW4zpCPZfJC04e04OjgBerCXBBCaiItqsRUUppLCr0G00">
<p>从Sokcet的connect方法可以看出，timeout参数会一致往下传递，最后到了PlainSocketImpl.socketConnect的native方法， java native方法是否真的很神秘？也不神秘，让我们一起看下JVM底层的实现,以下是jdk8-openjdk的源码</p>
<h4 id="PlainSocketImpl-c"><a href="#PlainSocketImpl-c" class="headerlink" title="PlainSocketImpl.c"></a>PlainSocketImpl.c</h4><img src="http://www.plantuml.com/plantuml/svg/bO_12e9048Rl-nJJHUfGU9OI8lPWH0Xhvq6s4RR6NS4rwktJagWyb9TX6FxvFdwHScwiSlfCFYahNcY0UGo3QmJR_9BZgHkMF7u5i7wi6sSjQI-6q9R9nZPNrEngwdXxcM6VdtfJaciyB5SGpiH7iFjKjzfJYUiqYK2FLAIE-SMF8OGW05FO8nLmK1ALtCbD1Z-aLGlvswY8tplrpibewPCZxW00">
<p>以下只截取部分重要的源码， 从源码上看，没设置超时时间时，jvm采用 connect的传统阻塞式方式，反之,则采用select/poll非阻塞式的方式, 由于poll/select都是得采用轮询的方式，在客户端没有设置超时的时候，采用轮询会带来不必要的开销，所以没设置超时时采用connect的阻塞方式是合理的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_net_PlainSocketImpl_socketConnect(JNIEnv *env, jobject <span class="keyword">this</span>,</span><br><span class="line">                                            jobject iaObj, jint port,</span><br><span class="line">                                            jint timeout)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (timeout &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">   connect_rv = NET_Connect(fd, (struct sockaddr *)&amp;him, len);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"> </span><br><span class="line">#ifndef USE_SELECT</span><br><span class="line">                &#123;</span><br><span class="line">                    struct pollfd pfd;</span><br><span class="line">                    pfd.fd = fd;</span><br><span class="line">                    pfd.events = POLLOUT;</span><br><span class="line"></span><br><span class="line">                    errno = <span class="number">0</span>;</span><br><span class="line">                    connect_rv = NET_Poll(&amp;pfd, <span class="number">1</span>, timeout);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                &#123;</span><br><span class="line">                    fd_set wr, ex;</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">t</span>;</span></span><br><span class="line"></span><br><span class="line">                    t.tv_sec = timeout / <span class="number">1000</span>;</span><br><span class="line">                    t.tv_usec = (timeout % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">                    FD_ZERO(&amp;wr);</span><br><span class="line">                    FD_SET(fd, &amp;wr);</span><br><span class="line">                    FD_ZERO(&amp;ex);</span><br><span class="line">                    FD_SET(fd, &amp;ex);</span><br><span class="line"></span><br><span class="line">                    errno = <span class="number">0</span>;</span><br><span class="line">                    connect_rv = NET_Select(fd+<span class="number">1</span>, <span class="number">0</span>, &amp;wr, &amp;ex, &amp;t);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (connect_rv == <span class="number">0</span>) &#123;</span><br><span class="line">                JNU_ThrowByName(env, JNU_JAVANETPKG <span class="string">"SocketTimeoutException"</span>,</span><br><span class="line">                            <span class="string">"connect timed out"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Timeout out but connection may still be established.</span></span><br><span class="line"><span class="comment">                 * At the high level it should be closed immediately but</span></span><br><span class="line"><span class="comment">                 * just in case we make the socket blocking again and</span></span><br><span class="line"><span class="comment">                 * shutdown input &amp; output.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                SET_BLOCKING(fd);</span><br><span class="line">                JVM_SocketShutdown(fd, <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* has connection been established */</span></span><br><span class="line">            optlen = <span class="keyword">sizeof</span>(connect_rv);</span><br><span class="line">            <span class="keyword">if</span> (JVM_GetSockOpt(fd, SOL_SOCKET, SO_ERROR, (<span class="keyword">void</span>*)&amp;connect_rv,</span><br><span class="line">                               &amp;optlen) &lt;<span class="number">0</span>) &#123;</span><br><span class="line">                connect_rv = errno;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="原理-Read-timed-out"><a href="#原理-Read-timed-out" class="headerlink" title="原理 Read timed out"></a>原理 Read timed out</h3><p>从下面这个时序图看， read timedout的原理就是通过系统调用 poll, 传入对应的socket文件句柄，在timeout时间内没有数据返回</p>
<img src="http://www.plantuml.com/plantuml/svg/TK_D2e904Bxt57CqgEYyXq38G30JrxjiwqHBkwxfR1JqyDaMz6UNOVZuVhcL1wIuRXnnQb4Oc2w0VuCC-bi5f0nQH-CH7rA5suvQ8IdJGjLFXcaq0o6FJhMuMWxhVi2PP90AKYU4DTBULj1vIjvtc0UxQWB_YypatLAhsfrBgMs7tYmgok8XUMtuuFWUbuxGb64MCsYirZufsoH9dCBLFr6UlsNV0000">
<p>当调用NET_Timeout没返回任何数据的时候, 根据情况会抛出 SocketTimeoutException或者SokcetException, 这个SocketTimeoutException就是我们经常遇到的read timed out</p>
<pre><code class="c"><span class="keyword">if</span> (timeout) {
    nread = NET_Timeout(fd, timeout);
    <span class="keyword">if</span> (nread &lt;= <span class="number">0</span>) {
        <span class="keyword">if</span> (nread == <span class="number">0</span>) {
            JNU_ThrowByName(env, JNU_JAVANETPKG <span class="string">"SocketTimeoutException"</span>,
                        <span class="string">"Read timed out"</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (nread == JVM_IO_ERR) {
            <span class="keyword">if</span> (errno == EBADF) {
                 JNU_ThrowByName(env, JNU_JAVANETPKG <span class="string">"SocketException"</span>, <span class="string">"Socket closed"</span>);
             } <span class="keyword">else</span> {
                 NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG <span class="string">"SocketException"</span>,
                                              <span class="string">"select/poll failed"</span>);
             }
        } <span class="keyword">else</span> <span class="keyword">if</span> (nread == JVM_IO_INTR) {
            JNU_ThrowByName(env, JNU_JAVAIOPKG <span class="string">"InterruptedIOException"</span>,
                        <span class="string">"Operation interrupted"</span>);
        }
        <span class="keyword">if</span> (bufP != BUF) {
            <span class="built_in">free</span>(bufP);
        }
        <span class="keyword">return</span> <span class="number">-1</span>;
    }
}
</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>“connect timed out” 是在指定时间内TCP连接未创建成功时jdk抛出的异常</li>
<li>“Read timed out”是在调用socketread后，指定时间内未收到响应时 jdk抛出的异常， 假如一个http响应10k, 每次socket read 4k, 那么就需要发起3次read的请求，假如timeout设置3秒，那么就允许每次read都等待3秒，最差的情况就是大概6秒读完数据，当然这得是极端的网络情况， 所以大部分情况下都是客户端发起请求后，在指定时间内收到的服务器的回包响应。<br>## </li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/06/浅谈web中的gzip压缩/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/06/浅谈web中的gzip压缩/" itemprop="url">浅谈web中的gzip压缩</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-06T10:27:22+08:00">
                2019-07-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/06/浅谈web中的gzip压缩/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/06/浅谈web中的gzip压缩/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>线上希望通过接入提高B国家用户的访问体验，所以在B国家新增了一个谷歌云服务的接入点</p>
<p><img src="https://drive.google.com/uc?export=view&amp;id=1891GT0ZRxuzsQzsXlpZTrZ6lCwaOWhLC" alt="翻墙中"></p>
<p>在测试中发现，转发的延迟达到了680ms,远远的超过了134ms（假如连接不复用情况下，那么2rtt也只是268ms）,经过排查，发现响应体约90K,tcp响应得分开90多个包传输，由于tcp各种问题，所以总时间拖长了（后续再总结）</p>
<p><strong>但是</strong></p>
<ul>
<li>A国家数据中心请求 是能够正常 压缩，相同的数据压缩后只有8KB</li>
<li>B国家数据中心请求 压缩异常</li>
</ul>
<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p>排查Nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gzip             on;</span><br><span class="line">gzip_comp_level  6;</span><br><span class="line">gzip_min_length  1k;</span><br><span class="line">gzip_buffers     4 8k;</span><br><span class="line">gzip_disable     &quot;MSIE [1-6]\.(?!.*SV1)&quot;;</span><br><span class="line">gzip_types       text/plain application/x-javascript text/css application/xml text/javascript application/javascript application/json;</span><br></pre></td></tr></table></figure>
<p>通过抓包对比两个数据中心的请求</p>
<p>发现谷歌SLB会在代理的请求增加以下Header标明是http的</p>
<blockquote>
<p>Via: 1.1 google</p>
</blockquote>
<p>通过查阅nginx配置,发现有个可疑的配置</p>
<p><a href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_proxied" target="_blank" rel="noopener">gzip_proxied</a>: nginx默认是不会对于来自代理服务器的请求就行压缩的，原因可参考<a href="https://stackoverflow.com/questions/33375304/what-are-the-options-for-the-gzip-proxied-directive-for" target="_blank" rel="noopener">what are the options for the gzip proxied for</a>,简而言之</p>
<ol>
<li>客户端支持的压缩协议不同，假如把响应gzip放在代理服务器上，代理服务器还是得解压了再按客户端支持的协议重新下发，或者客户端不支持或者不期望压缩。</li>
<li>对于某些内容，得基于未压缩的文件进行处理，例如视频的播放或者断点下载，客户端发起<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests#%E5%8D%95%E4%B8%80%E8%8C%83%E5%9B%B4" target="_blank" rel="noopener">range</a>请求，服务端依然得基于未压缩的内容进行处理。</li>
</ol>
<p>所以Nginx对于有via头的，默认则不压缩是合理的</p>
<p>对于该情况，由于对外的都是api接口，不存在cache的情况，所以添加以下配置就解决了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip_proxied: any</span><br></pre></td></tr></table></figure>
<p>web到处充斥着压缩，那么nginx是怎么判断什么时候需要处理的？tomcat呢？ 各个工具间是怎么保证不产生冲突的。</p>
<h2 id="先总结"><a href="#先总结" class="headerlink" title="先总结"></a>先总结</h2><ol>
<li>nginx提供了一系列的gzip_前缀的配置控制是否压缩，tomcat由于角色是web容器，所以提供的选项只有3个，连compress level都不提供。 </li>
<li>在配置启用压缩的前提下， 还会检查 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Encoding" target="_blank" rel="noopener">Content-Encoding</a>是否存在gzip值，对于nginx会更加的详细，会判断多额外的边界条件，例如gzip, q=0也禁用。 从这点上看，nginx+tomcat的这种主流架构，尽管同时启用了gzip,都不会产生冲突。</li>
<li>http针对压缩有accept-encoding（针对请求）以及Content-Encoding(针对响应)，所以服务器间压缩前判断是否Content-Encoding已经标明该内容以及压缩了，则不进行重复压缩。</li>
</ol>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><h3 id="nginx源码"><a href="#nginx源码" class="headerlink" title="nginx源码"></a>nginx源码</h3><h4 id="ngx-http-gzip-filter-module-c"><a href="#ngx-http-gzip-filter-module-c" class="headerlink" title="ngx_http_gzip_filter_module.c"></a>ngx_http_gzip_filter_module.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_gzip_header_filter(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>       *h;</span><br><span class="line">    <span class="keyword">ngx_http_gzip_ctx_t</span>   *ctx;</span><br><span class="line">    <span class="keyword">ngx_http_gzip_conf_t</span>  *conf;</span><br><span class="line"></span><br><span class="line">    conf = ngx_http_get_module_loc_conf(r, ngx_http_gzip_filter_module);</span><br><span class="line"></span><br><span class="line">	 <span class="comment">// 以下是不进行zip的条件</span></span><br><span class="line">	 <span class="comment">// 没配置gzip: one</span></span><br><span class="line">    <span class="keyword">if</span> (!conf-&gt;enable</span><br><span class="line">        <span class="comment">//gzip 状态错误</span></span><br><span class="line">        || (r-&gt;headers_out.status != NGX_HTTP_OK</span><br><span class="line">            &amp;&amp; r-&gt;headers_out.status != NGX_HTTP_FORBIDDEN</span><br><span class="line">            &amp;&amp; r-&gt;headers_out.status != NGX_HTTP_NOT_FOUND)</span><br><span class="line">        <span class="comment">// Content-Encoding header不为空，</span></span><br><span class="line">        || (r-&gt;headers_out.content_encoding</span><br><span class="line">            &amp;&amp; r-&gt;headers_out.content_encoding-&gt;value.len)</span><br><span class="line">        <span class="comment">//响应体的大小小于设置的的最小长度 gzip_min_length</span></span><br><span class="line">        || (r-&gt;headers_out.content_length_n != <span class="number">-1</span></span><br><span class="line">            &amp;&amp; r-&gt;headers_out.content_length_n &lt; conf-&gt;min_length)</span><br><span class="line">        <span class="comment">//Content-Type不在配置gzip_types范围内</span></span><br><span class="line">        || ngx_http_test_content_type(r, &amp;conf-&gt;types) == <span class="literal">NULL</span></span><br><span class="line">        <span class="comment">//没响应体</span></span><br><span class="line">        || r-&gt;header_only)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_next_header_filter(r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    r-&gt;gzip_vary = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;gzip_tested) &#123;</span><br><span class="line">    	  <span class="comment">//下面说明</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_http_gzip_ok(r) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> ngx_http_next_header_filter(r);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//当gzip_tested为true时表示已经判断过是否支持gzip, gzip_ok则为判断的结果</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!r-&gt;gzip_ok) &#123;</span><br><span class="line">        <span class="keyword">return</span> ngx_http_next_header_filter(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ngx-http-core-module"><a href="#ngx-http-core-module" class="headerlink" title="ngx_http_core_module"></a>ngx_http_core_module</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">ngx_int_t</span></span><br><span class="line">ngx_http_gzip_ok(<span class="keyword">ngx_http_request_t</span> *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">time_t</span>                     date, expires;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                 p;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>               *cc;</span><br><span class="line">    <span class="keyword">ngx_table_elt_t</span>           *e, *d, *ae;</span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    r-&gt;gzip_tested = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//是否是nginx子请求，可参考nginx batch api</span></span><br><span class="line">    <span class="keyword">if</span> (r != r-&gt;main) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//客户端没传 Accept-Encoding</span></span><br><span class="line">    ae = r-&gt;headers_in.accept_encoding;</span><br><span class="line">    <span class="keyword">if</span> (ae == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ae-&gt;value.len &lt; <span class="keyword">sizeof</span>(<span class="string">"gzip"</span>) - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * test first for the most common case "gzip,...":</span></span><br><span class="line"><span class="comment">     *   MSIE:    "gzip, deflate"</span></span><br><span class="line"><span class="comment">     *   Firefox: "gzip,deflate"</span></span><br><span class="line"><span class="comment">     *   Chrome:  "gzip,deflate,sdch"</span></span><br><span class="line"><span class="comment">     *   Safari:  "gzip, deflate"</span></span><br><span class="line"><span class="comment">     *   Opera:   "gzip, deflate"</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">	 <span class="comment">//Accept-Encoding 不包含合法gzip</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_memcmp(ae-&gt;value.data, <span class="string">"gzip,"</span>, <span class="number">5</span>) != <span class="number">0</span></span><br><span class="line">        &amp;&amp; ngx_http_gzip_accept_encoding(&amp;ae-&gt;value) != NGX_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//是否旧的不兼容的UA</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.msie6 &amp;&amp; clcf-&gt;gzip_disable_msie6) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;http_version &lt; clcf-&gt;gzip_http_version) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.via == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> ok;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = clcf-&gt;gzip_proxied;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//gzip_proxied: off //默认情况</span></span><br><span class="line">    <span class="keyword">if</span> (p &amp; NGX_HTTP_GZIP_PROXIED_OFF) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//gzip_proxied: any</span></span><br><span class="line">    <span class="keyword">if</span> (p &amp; NGX_HTTP_GZIP_PROXIED_ANY) &#123;</span><br><span class="line">        <span class="keyword">goto</span> ok;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//gzip_proxied: auth</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_in.authorization &amp;&amp; (p &amp; NGX_HTTP_GZIP_PROXIED_AUTH)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> ok;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    e = r-&gt;headers_out.expires;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e) &#123;</span><br><span class="line"></span><br><span class="line">		 <span class="comment">//对应 enables compression if a response header includes the “Expires” field with a value that disables caching;</span></span><br><span class="line">        <span class="keyword">if</span> (!(p &amp; NGX_HTTP_GZIP_PROXIED_EXPIRED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        expires = ngx_parse_http_time(e-&gt;value.data, e-&gt;value.len);</span><br><span class="line">        <span class="keyword">if</span> (expires == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        d = r-&gt;headers_out.date;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (d) &#123;</span><br><span class="line">            date = ngx_parse_http_time(d-&gt;value.data, d-&gt;value.len);</span><br><span class="line">            <span class="keyword">if</span> (date == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            date = ngx_time();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (expires &lt; date) &#123;</span><br><span class="line">            <span class="keyword">goto</span> ok;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cc = &amp;r-&gt;headers_out.cache_control;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//gzip_proxied: no-cache/no-store/private等各种情况</span></span><br><span class="line">    <span class="keyword">if</span> (cc-&gt;elts) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((p &amp; NGX_HTTP_GZIP_PROXIED_NO_CACHE)</span><br><span class="line">            &amp;&amp; ngx_http_parse_multi_header_lines(cc, &amp;ngx_http_gzip_no_cache,</span><br><span class="line">                                                 <span class="literal">NULL</span>)</span><br><span class="line">               &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> ok;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((p &amp; NGX_HTTP_GZIP_PROXIED_NO_STORE)</span><br><span class="line">            &amp;&amp; ngx_http_parse_multi_header_lines(cc, &amp;ngx_http_gzip_no_store,</span><br><span class="line">                                                 <span class="literal">NULL</span>)</span><br><span class="line">               &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> ok;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((p &amp; NGX_HTTP_GZIP_PROXIED_PRIVATE)</span><br><span class="line">            &amp;&amp; ngx_http_parse_multi_header_lines(cc, &amp;ngx_http_gzip_private,</span><br><span class="line">                                                 <span class="literal">NULL</span>)</span><br><span class="line">               &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> ok;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//no_last_modified</span></span><br><span class="line">    <span class="keyword">if</span> ((p &amp; NGX_HTTP_GZIP_PROXIED_NO_LM) &amp;&amp; r-&gt;headers_out.last_modified) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> 	 <span class="comment">//no_etag</span></span><br><span class="line">    <span class="keyword">if</span> ((p &amp; NGX_HTTP_GZIP_PROXIED_NO_ETAG) &amp;&amp; r-&gt;headers_out.etag) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">ok:</span><br><span class="line"></span><br><span class="line">    r-&gt;gzip_ok = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Tomcat源码"><a href="#Tomcat源码" class="headerlink" title="Tomcat源码"></a>Tomcat源码</h3><h5 id="tomcat针对压缩，可配置的选项相对较少"><a href="#tomcat针对压缩，可配置的选项相对较少" class="headerlink" title="tomcat针对压缩，可配置的选项相对较少"></a>tomcat针对压缩，<a href="https://tomcat.apache.org/tomcat-8.5-doc/config/http.html" target="_blank" rel="noopener">可配置的选项</a>相对较少</h5><ul>
<li>compressibleMimeType</li>
<li>compression</li>
<li>compressionMinSize<br>基本就是允许什么content-type的进行压缩，启用压缩的大小是多少</li>
</ul>
<h4 id="org-apache-coyote-http11-Http11Processor"><a href="#org-apache-coyote-http11-Http11Processor" class="headerlink" title="org.apache.coyote.http11.Http11Processor"></a>org.apache.coyote.http11.Http11Processor</h4><p>以http1.1协议为例，主要逻辑为,以下只说明压缩后会改变了什么http的头部</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (useCompression) &#123;</span><br><span class="line">    outputBuffer.addActiveFilter(outputFilters[Constants.GZIP_FILTER]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置了Content-Encoding</span></span><br><span class="line">    headers.setValue(<span class="string">"Content-Encoding"</span>).setString(<span class="string">"gzip"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// If it might be compressed, set the Vary header</span></span><br><span class="line"><span class="keyword">if</span> (isCompressible) &#123;</span><br><span class="line">    <span class="comment">// Make Proxies happy via Vary (from mod_deflate)</span></span><br><span class="line">    MessageBytes vary = headers.getValue(<span class="string">"Vary"</span>);</span><br><span class="line">    <span class="keyword">if</span> (vary == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Add a new Vary header</span></span><br><span class="line">        headers.setValue(<span class="string">"Vary"</span>).setString(<span class="string">"Accept-Encoding"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vary.equals(<span class="string">"*"</span>)) &#123;</span><br><span class="line">        <span class="comment">// No action required</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Merge into current header</span></span><br><span class="line">        headers.setValue(<span class="string">"Vary"</span>).setString(</span><br><span class="line">                vary.getString() + <span class="string">",Accept-Encoding"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/17/Tcp-从jedis看常用的tcp参数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/17/Tcp-从jedis看常用的tcp参数/" itemprop="url">Tcp - 从jedis看常用的tcp参数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-17T09:19:35+08:00">
                2018-05-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/17/Tcp-从jedis看常用的tcp参数/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/05/17/Tcp-从jedis看常用的tcp参数/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>由于微服务的兴起，以及公司内部各种服务间的各种调用，最近也遇过几次线上大量TIME_WAIT的问题，虽然知道怎么解决，但也点燃了我对tcp协议重新温习学习的兴趣。</p>
<p>从何学习呢？重新看下几百多页的《TCP/IP详解》，那太花时间了，以前页看过一次。不如从一些优秀的开源项目里，看下他们是怎么使用tcp建立连接的？那就从jedis开始吧。😃</p>
<h2 id="源码分析步骤"><a href="#源码分析步骤" class="headerlink" title="源码分析步骤"></a>源码分析步骤</h2><h3 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/xetorthio/jedis.git</span><br><span class="line">git checkout tags/jedis-2.9.0</span><br></pre></td></tr></table></figure>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>从最简单的jedis.set追到底层的tcp网络编程吧</p>
<h4 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h4><img src="http://www.plantuml.com/plantuml/svg/XSzD2i8m40NWVKwHPGiLNBiGf6xymOLwWP0yDDZEX6IgU7jjQnK5TPNXvPkP99WetlfWIFGIpYUbkaEFfhgiF4WcEa5KNtSf4y6APsflo9LSruQSUkMVolQrKZR22FIExQaT-TRGXzsoBPg4cNCHAMKI6-JVxGe8iygVyG_kRTZm79Mv_fCxNdiw87Qk67-JZrzbX8jUKDlMviEpZvoaq86ZvCL0xmFslWOtydFxmsI9d_e6">
<h4 id="核心tcp参数设置"><a href="#核心tcp参数设置" class="headerlink" title="核心tcp参数设置"></a>核心tcp参数设置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">socket.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">socket.setKeepAlive(<span class="keyword">true</span>); <span class="comment">// Will monitor the TCP connection is</span></span><br><span class="line"><span class="comment">// valid</span></span><br><span class="line">socket.setTcpNoDelay(<span class="keyword">true</span>); <span class="comment">// Socket buffer Whetherclosed, to</span></span><br><span class="line"><span class="comment">// ensure timely delivery of data</span></span><br><span class="line">socket.setSoLinger(<span class="keyword">true</span>, <span class="number">0</span>); <span class="comment">// Control calls close () method</span></span><br><span class="line">socket.setSoTimeout(soTimeout);</span><br></pre></td></tr></table></figure>
<h5 id="1-setReuseAddress"><a href="#1-setReuseAddress" class="headerlink" title="1 setReuseAddress"></a>1 setReuseAddress</h5><p>可以看出setReuseAddress本质上就是对SO_REUSEADDR的设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReuseAddress</span><span class="params">(<span class="keyword">boolean</span> on)</span> <span class="keyword">throws</span> SocketException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isClosed())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SocketException(<span class="string">"Socket is closed"</span>);</span><br><span class="line">    getImpl().setOption(SocketOptions.SO_REUSEADDR, Boolean.valueOf(on));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>SO_REUSEADDR</strong>主要的作用(<a href="https://stackoverflow.com/questions/14388706/socket-options-so-reuseaddr-and-so-reuseport-how-do-they-differ-do-they-mean-t?answertab=active#tab-top" target="_blank" rel="noopener">其它作用</a>)就是对TIME_WAIT连接的重用，对于jedis,作者应该是希望客户端重启后，重新创建到redis服务器的tcp连接能够重用之前的接口。因为客户端重启时，活跃的jedis连接由于时客户端主动关闭，会持续2*MSL的TIME_WAIT状态，在此期间会一直占用着客户端端口。<br>MSL的大小可通过以下命令查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl -a | grep tcp_fin_timeout</span><br><span class="line">tcp_fin_timeout = 60</span><br></pre></td></tr></table></figure>
<h5 id="2-setKeepAlive"><a href="#2-setKeepAlive" class="headerlink" title="2 setKeepAlive"></a>2 setKeepAlive</h5><p><strong>SO_KEEPALIVE</strong>是tcp利用心跳机制保持连接的存活，假如连接已经断开，则会响应错误码Broken Pipe给上层应用,由于keepalive发起心跳包的开始实际比较迟，对于调整后的linux操作系统仍然需要5分钟，数值过小又会导致过多无用的包发出，5分钟的时间长度发出后，通常也会由于各种各样的原因连接早已被销毁，例如客户端服务器端的连接经过了lvs，haproxy各种各样的代理，代理服务器本身也会有个keepalive的最长时间。<br>一般业务对于SO_KEEPALIVE的依赖比较小，假如需要保持连接的话，会自己进行一些存活性的维持和判断，例如</p>
<ol>
<li>定期小周期发送心跳包keep alive</li>
<li>在使用连接前进行判断，例如连接池通常采用的testOnBorrow, testOnReturn之类的机制。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -a | grep tcp_keepalive   </span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 75</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 9</span><br><span class="line">net.ipv4.tcp_keepalive_time = 300 //通常默认值为7200</span><br></pre></td></tr></table></figure>
<h5 id="3-setTcpNoDelay"><a href="#3-setTcpNoDelay" class="headerlink" title="3 setTcpNoDelay"></a>3 setTcpNoDelay</h5><p>TCP_NODELAY的作用就是禁用Nagle，减少由于小包带来的推迟发送的延迟</p>
<blockquote>
<p>If set, disable the Nagle algorithm.  This means that segments are always sent  as  soon  as  possible,<br>even  if  there is only a small amount of data.  When not set, data is buffered until there is a suffi‐<br>cient amount to send out, thereby avoiding the frequent sending of small packets, which results in poor<br>utilization of the network.  This option is overridden by TCP_CORK; however, setting this option forces<br>an explicit flush of pending output, even if TCP_CORK is currently set.</p>
</blockquote>
<h5 id="4-setSoLinger-true-0"><a href="#4-setSoLinger-true-0" class="headerlink" title="4 setSoLinger(true, 0)"></a>4 setSoLinger(true, 0)</h5><p>这个选项的设置就是jedis关闭的时候直接发送RST,而不是按照正常的4次挥手的关闭流程，避免了客户端TIME_WAIT的情况，但不是一个很好的pratice,因为服务端会只会收到RST,这里留下一个问题，redis是如何处理rst的，是否是直接忽略，不然就会堆积很多错误日志？</p>
<h5 id="5-socket-setSoTimeout-soTimeout"><a href="#5-socket-setSoTimeout-soTimeout" class="headerlink" title="5 socket.setSoTimeout(soTimeout)"></a>5 socket.setSoTimeout(soTimeout)</h5><p>SO_TIMEOUT的作用就是设置以下三个socket操作的超时时间，很明显，ServerSocket.accept()是针对服务端而言，DatagramSocket.receive()是针对UDP,在这里jedis生效的是SocketInputStream.read()，作用就是jedis发送命令后，开始读redis请求的响应时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ServerSocket.accept();</span><br><span class="line">SocketInputStream.read();</span><br><span class="line">DatagramSocket.receive();</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>tcp是一个非常复杂的网络协议，但对于“客户端”的tcp编程其实也不是特别难，从jedis在tcp的使用上看，直接用了blocking io,同时设置了5个参数，就满足了大部分场合的使用，对于一般互联网的服务，也只是使用多一个池化JedisPool而已。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/03/无处不在的常量池/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/03/无处不在的常量池/" itemprop="url">无处不在的常量池</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-03T13:58:52+08:00">
                2018-05-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/03/无处不在的常量池/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/05/03/无处不在的常量池/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>在看redis源码的过程中，看到了redis为了高效使用内存，内部维护了个Integer常量池，使得redis对于频繁出现的Integer,能够减少内存的使用，也减少了内存申请和释放的开销，所以把各种场景的常量池做次归纳。</p>
<h1 id="各种常量池"><a href="#各种常量池" class="headerlink" title="各种常量池"></a>各种常量池</h1><h2 id="Java常量池"><a href="#Java常量池" class="headerlink" title="Java常量池"></a>Java常量池</h2><h3 id="JVM字符串常量池"><a href="#JVM字符串常量池" class="headerlink" title="JVM字符串常量池"></a>JVM字符串常量池</h3><p>这个太多常见了，直接google即可</p>
<h3 id="Integer常量池"><a href="#Integer常量池" class="headerlink" title="Integer常量池"></a>Integer常量池</h3><p>对于Intger常量池，可以看下面这个例子，a和b变量都是引用类型，但进行“==”判断是否是同个引用的时候返回有时会返回true,这个是什么原因呢？因为JVM内部自己维护了个常量池，a和b都是指向了相同的“常量”实例，所以”==”会返回true, 而cd的值超出了默认常量值的范围，所以“==”返回false.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">  Integer a = <span class="number">1</span>;</span><br><span class="line">  Integer b = <span class="number">1</span>;</span><br><span class="line">  System.out.println(a == b); <span class="comment">//true</span></span><br><span class="line"></span><br><span class="line">  Integer c = <span class="number">128</span>;</span><br><span class="line">  Integer d = <span class="number">128</span>;</span><br><span class="line">  System.out.println(c == d); <span class="comment">//false，默认情况，假如修改了jvm参数设置常量池大小，那么该结果有可能为true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那在jdk里面是如何使用到这个常量池的？<br><a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/Integer.java#829" target="_blank" rel="noopener">源码</a>,从Integer.valueOf()方法中可以看出这里是使用了cache,也就是Integer常量值，对于 Integer a = 1这种statement, jvm其实也就是调用了valueOf方法进行boxing. IntegerCache.high是可以通过设置jvm参数进行改变。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)</span><br><span class="line">        <span class="keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Integer(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以以下这种坏味道的代码，也不会造成明显的性能影响</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Integer i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">  <span class="comment">//通常会有很多言论说这种代码会创建额外的Integer对象，但其实不然，因为</span></span><br><span class="line">  <span class="comment">//jvm已经在背后做了优化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Redis-常量池"><a href="#Redis-常量池" class="headerlink" title="Redis 常量池"></a>Redis 常量池</h2><p>通常会遇到redis的一种使用场景，只是想通过设置某个key,然后通过判断某个key是否存在，value的值没任何意义，这个时候就会纠结value应该取什么值比较省内存,如果通过<a href="https://github.com/sripathikrishnan/redis-rdb-tools" target="_blank" rel="noopener">redis-rdb-tools</a>进行内存计算，可以得出以下结果，空字符串的value内存占用比保存’1’占用了多8个字节的长度，这是因为对于’’需要保存一个空字符串，而对于’1’，则命中了redis整形常量池，无需而外分配内存保存’1’,整个数据存储的占用等另开一篇文章说明。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> k <span class="string">''</span> <span class="comment">#总共占用56字节</span></span><br><span class="line"><span class="built_in">set</span> k 1  <span class="comment">#总共占用48字节</span></span><br></pre></td></tr></table></figure>
<p>Redis在编码字符串是会尝试进行一些压缩编码，以下代码就是redis使用整形常量池的片段</p>
<h3 id="常量池初始化"><a href="#常量池初始化" class="headerlink" title="常量池初始化"></a><a href="https://github.com/antirez/redis/blob/f17d82961da78933e9311b122a2ac699b3fde0f9/src/server.c#L1324" target="_blank" rel="noopener">常量池初始化</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; OBJ_SHARED_INTEGERS; j++) &#123;</span><br><span class="line">    shared.integers[j] =</span><br><span class="line">        makeObjectShared(createObject(OBJ_STRING,(<span class="keyword">void</span>*)(<span class="keyword">long</span>)j));</span><br><span class="line">    shared.integers[j]-&gt;encoding = OBJ_ENCODING_INT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常量池使用"><a href="#常量池使用" class="headerlink" title="常量池使用"></a><a href="https://github.com/antirez/redis/blob/f17d82961da78933e9311b122a2ac699b3fde0f9/src/object.c#L412" target="_blank" rel="noopener">常量池使用</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (len &lt;= <span class="number">20</span> &amp;&amp; string2l(s,len,&amp;value)) &#123;</span><br><span class="line">    <span class="comment">/* This object is encodable as a long. Try to use a shared object.</span></span><br><span class="line"><span class="comment">     * Note that we avoid using shared integers when maxmemory is used</span></span><br><span class="line"><span class="comment">     * because every object needs to have a private LRU field for the LRU</span></span><br><span class="line"><span class="comment">     * algorithm to work well. */</span></span><br><span class="line">    <span class="keyword">if</span> ((server.maxmemory == <span class="number">0</span> ||</span><br><span class="line">        !(server.maxmemory_policy &amp; MAXMEMORY_FLAG_NO_SHARED_INTEGERS)) &amp;&amp;</span><br><span class="line">        value &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">        value &lt; OBJ_SHARED_INTEGERS)<span class="comment">//redis会初始化 0至OBJ_SHARED_INTEGERS的常量，</span></span><br><span class="line">    &#123;</span><br><span class="line">        decrRefCount(o);</span><br><span class="line">        incrRefCount(shared.integers[value]);</span><br><span class="line">        <span class="keyword">return</span> shared.integers[value];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_RAW) sdsfree(o-&gt;ptr);</span><br><span class="line">        o-&gt;encoding = OBJ_ENCODING_INT;</span><br><span class="line">        o-&gt;ptr = (<span class="keyword">void</span>*) value;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/24/Spring-Rabbitmq-bug排查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/24/Spring-Rabbitmq-bug排查/" itemprop="url">Spring - Rabbitmq bug排查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-24T09:35:23+08:00">
                2018-04-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/24/Spring-Rabbitmq-bug排查/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/24/Spring-Rabbitmq-bug排查/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>项目同时连接多个rabbitmq,使用spring-rabbit进行连接，版本号为1.4.6.RELEASE</p>
<p>某天发现rabbitmq服务器日志错误日志出现大量</p>
<blockquote>
<p>Channel error on connection &lt;0.3019.46&gt; (1.1.1.1:41724 -&gt; 1.2.3.4:5672, vhost: ‘/‘, user: ‘xunhuan_prod’), channel 31: operation queue.declare caused a channel exception not_found: “no queue ‘wolfkill.groups.online.time.queue’ in vhost ‘/‘“</p>
</blockquote>
<h3 id="rabbitmq架构"><a href="#rabbitmq架构" class="headerlink" title="rabbitmq架构"></a>rabbitmq架构</h3><p>两个rabbitmq集群，使用不同的virtual host</p>
<table>
<thead>
<tr>
<th>集群</th>
<th>Virtual Host</th>
<th>Queue</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>service_A</td>
<td>A1, A2</td>
</tr>
<tr>
<td>B</td>
<td>/</td>
<td>wolfkill.groups.online.time.queue</td>
</tr>
</tbody>
</table>
<h2 id="故障排查"><a href="#故障排查" class="headerlink" title="故障排查"></a>故障排查</h2><h3 id="检查spring-xml配置文件"><a href="#检查spring-xml配置文件" class="headerlink" title="检查spring xml配置文件"></a>检查spring xml配置文件</h3><ul>
<li>两个rabbitmq配置都已经分开</li>
<li>queue和exchange都全部加上了<a href="https://docs.spring.io/spring-amqp/reference/htmlsingle/#conditional-declaration" target="_blank" rel="noopener">declared-by</a></li>
</ul>
<h3 id="检查源代码"><a href="#检查源代码" class="headerlink" title="检查源代码"></a>检查源代码</h3><h4 id="SimpleMessageListenerContainer"><a href="#SimpleMessageListenerContainer" class="headerlink" title="SimpleMessageListenerContainer"></a>SimpleMessageListenerContainer</h4><p>初始化的时候判断当前RabbitAdmin的数量，假如不为空的话，就赋值给成员变量RabbitAdmin,看到这里时已经感觉有点不妥，这也太过随意了吧😮，该项目接入了两个mq,所以RabbitAdmin对应着有两个。<br><a href="https://github.com/spring-projects/spring-amqp/blob/f9586b5de7e852033a5ece2cb229f3cac740e053/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java#L685" target="_blank" rel="noopener">源代码传送门</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.doStart();</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.rabbitAdmin == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.getApplicationContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="comment">//初始化时会随机拿第一个RabbitAdmin设置为当前的变量以供后续使用，但当项目有多个RabbitAdmin时则可能设置错误</span></span><br><span class="line">		Map&lt;String, RabbitAdmin&gt; admins = <span class="keyword">this</span>.getApplicationContext().getBeansOfType(RabbitAdmin.class);</span><br><span class="line">		<span class="keyword">if</span> (!admins.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.rabbitAdmin = admins.values().iterator().next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在doStart之后执行的代码，拿了不确定的RabbitAdmin继续declare Queue(调用Rabbitmq Broker api).<br><a href="https://github.com/spring-projects/spring-amqp/blob/f9586b5de7e852033a5ece2cb229f3cac740e053/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java#L963" target="_blank" rel="noopener">源代码传送门</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">redeclareElementsIfNecessary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		ApplicationContext applicationContext = <span class="keyword">this</span>.getApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (applicationContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">			Set&lt;String&gt; queueNames = <span class="keyword">this</span>.getQueueNamesAsSet();</span><br><span class="line">			Map&lt;String, Queue&gt; queueBeans = applicationContext.getBeansOfType(Queue.class);</span><br><span class="line">			<span class="keyword">for</span> (Entry&lt;String, Queue&gt; entry : queueBeans.entrySet()) &#123;</span><br><span class="line">				Queue queue = entry.getValue();</span><br><span class="line">				<span class="comment">//rabbitAdmin.getQueueProperties会调用channel.queueDeclarePassive,所以这个时候会拿了错误的RabbitAdmin进行创建，所以该处是问题所在</span></span><br><span class="line">				<span class="keyword">if</span> (queueNames.contains(queue.getName()) &amp;&amp;</span><br><span class="line">						<span class="keyword">this</span>.rabbitAdmin.getQueueProperties(queue.getName()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"At least one queue is missing: "</span> + queue.getName()</span><br><span class="line">								+ <span class="string">"; redeclaring context exchanges, queues, bindings."</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">this</span>.rabbitAdmin.initialize();</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="检查新版本代码"><a href="#检查新版本代码" class="headerlink" title="检查新版本代码"></a>检查新版本代码</h4><p><a href="https://github.com/spring-projects/spring-amqp/blob/233aa11cf9046fb8c2c3c5a373d09d9e645aa2b3/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java#L801" target="_blank" rel="noopener">源代码传送门</a></p>
<p>检查最新的版本1.7.3.RELEASE, 最新版本已经加了条件判断，当只有一个RabbitAdmin时才会设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.rabbitAdmin == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.getApplicationContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		Map&lt;String, RabbitAdmin&gt; admins = <span class="keyword">this</span>.getApplicationContext().getBeansOfType(RabbitAdmin.class);</span><br><span class="line">		<span class="keyword">if</span> (admins.size() == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.rabbitAdmin = admins.values().iterator().next();</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p><strong>所以该问题的原因是spring rabbitmq在项目同时存在多个RabbitAdmin时，误用了RabbitAdmin, RabbitAdmin就是分别对应着不同的Rabbitmq集群，在该场景下，用了RabbitAdmin A去创建原本应该创建在B上的Virtual Host为“/”的Queue”wolfkill.groups.online.time.queue”.</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>该问题是spring-rabbitmq模块的bug,搞版本已经解决</li>
<li>使用开源工具时，尽可能的使用最新的版本。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/04/spring-data-mongo源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/04/spring-data-mongo源码解析/" itemprop="url">spring-data-mongo源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-04T09:50:00+08:00">
                2018-04-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/04/spring-data-mongo源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/04/spring-data-mongo源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>由于项目已经很重的使用了mongodb, 对于mongodb的访问主要采用<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/" target="_blank" rel="noopener">spring-data-mongo</a>,该框架对于一些简单的查询语句都能直接通过<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#mongodb.repositories.queries" target="_blank" rel="noopener">Query methods</a>,需要手工写查询语句的情况也很少，这种magic般的使用方法也引起了我的好奇，以前写查询语句的时候规范也是说，对于进行sql查询的方法应当和查询的条件保持一致，例如findByXXX之类，没想到spring data只需要按照类似这种规范，就能直接生成对应的查询语句，那么底层是怎么实现的？</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>了解spring接口类方法的原理。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>通过spring boot快速搭建<a href="https://github.com/hoswey/example-spring-data-mongo.git" target="_blank" rel="noopener">demo</a>,该demo包含一个MongoRepository,通过main函数执行一些简单的查询方法。</p>
<p><a href="https://github.com/hoswey/example-spring-data-mongo/blob/master/src/main/java/com/example/spring/mongo/demo/repository/ArticleRepository.java" target="_blank" rel="noopener">ArticleRepositroy</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 无需任何实现，使用findByAuthor时，spring data会自动生成mongodb查询语句</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArticleRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Article</span>, <span class="title">String</span>&gt;,</span></span><br><span class="line"><span class="class">    <span class="title">CustomizedArticleRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">List&lt;Article&gt; <span class="title">findByAuthorOrderByIdDescAllIgnoreCase</span><span class="params">(String author)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">List&lt;Article&gt; <span class="title">findByNumOfLikeIsGreaterThan</span><span class="params">(<span class="keyword">int</span> numOfLike)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="Spring-Boot配置"><a href="#Spring-Boot配置" class="headerlink" title="Spring Boot配置"></a>Spring Boot配置</h3><p>要了解spring data mongo原理，最直接的方法就是看repository是怎么初始化的，由于该demo是基于spring boot，按照spring boot的特点，初始化的控制都是由各种AutoConfiguration引导。</p>
<p>直接在IDE里搜索 *Mongo*AutoConfiguration, 可以发现以下配置类</p>
<h4 id="相关配置类"><a href="#相关配置类" class="headerlink" title="相关配置类"></a>相关配置类</h4><ul>
<li>org.springframework.boot.autoconfigure.mongo，MongoClient,MongoTemplate相关配置<img src="/2018/04/04/spring-data-mongo源码解析/pasted-0.png" title="example.jpg"></li>
<li>org.springframework.boot.autoconfigure.data.mongo，data mongo相关配置，涉及到核心类Repository<img src="/2018/04/04/spring-data-mongo源码解析/pasted-1.png" title="example.jpg">
</li>
</ul>
<p>spring data mongo主要是由这两个package下的配置类初始化,对于Repository类的初始化，核心类是<br>MongoRepositoriesAutoConfigureRegistrar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoRepositoriesAutoConfigureRegistrar</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">AbstractRepositoryConfigurationSourceSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;? extends Annotation&gt; getAnnotation() &#123;</span><br><span class="line">		<span class="keyword">return</span> EnableMongoRepositories.class;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; getConfiguration() &#123;</span><br><span class="line">		<span class="keyword">return</span> EnableMongoRepositoriesConfiguration.class;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RepositoryConfigurationExtension <span class="title">getRepositoryConfigurationExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MongoRepositoryConfigurationExtension();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@EnableMongoRepositories</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableMongoRepositoriesConfiguration</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类继承了<strong>AbstractRepositoryConfigurationSourceSupport</strong>并且实现了三个抽象方法，查看了AbstractRepositoryConfigurationSourceSupport的子类，可以发现spring data很多模块都是继承该类，所以<strong>AbstractRepositoryConfigurationSourceSupport</strong>是Spring data初始化的核心</p>
<ul>
<li>AbstractRepositoryConfigurationSourceSupport<ul>
<li>CassandraRepositoriesAutoConfigureRegistrar </li>
<li>MongoRepositoriesAutoConfigureRegistrar </li>
<li>ElasticsearchRepositoriesRegistrar </li>
<li>LdapRepositoriesRegistrar </li>
<li>CassandraReactiveRepositoriesAutoConfigureRegistrar </li>
<li>CouchbaseRepositoriesRegistrar </li>
<li>JpaRepositoriesAutoConfigureRegistrar </li>
<li>CouchbaseReactiveRepositoriesRegistrar </li>
<li>RedisRepositoriesAutoConfigureRegistrar </li>
<li>Neo4jRepositoriesAutoConfigureRegistrar </li>
<li>SolrRepositoriesRegistrar </li>
<li>MongoReactiveRepositoriesAutoConfigureRegistrar</li>
</ul>
</li>
</ul>
<h4 id="MongoRepositoriesAutoConfigureRegistrar"><a href="#MongoRepositoriesAutoConfigureRegistrar" class="headerlink" title="MongoRepositoriesAutoConfigureRegistrar"></a>MongoRepositoriesAutoConfigureRegistrar</h4><p>该类实现的三个方法都是返回了配置类POJO，这里主要有两个对象</p>
<ol>
<li>EnableMongoRepositories 配置类，方法getRepositoryFactoryBeanClassName返回MongoRepositoryFactoryBean，该工厂bean返回了Repositoryd的代理</li>
<li>RepositoryConfigurationExtension 该类主要是在Spring Data通用的bean初始化阶段加入mongodb特有的一些配置，其大部分方法都是接受了BeanDefinitionBuilder进行一些</li>
</ol>
<details><summary>EnableMongoRepositories</summary><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableMongoRepositories &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Alias for the &#123;<span class="doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation declarations e.g.:</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> <span class="doctag">@EnableMongoRepositories</span>("org.my.pkg")&#125; instead of &#123;<span class="doctag">@code</span> <span class="doctag">@EnableMongoRepositories</span>(basePackages="org.my.pkg")&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Base packages to scan for annotated components. &#123;<span class="doctag">@link</span> #value()&#125; is an alias for (and mutually exclusive with) this</span></span><br><span class="line"><span class="comment">	 * attribute. Use &#123;<span class="doctag">@link</span> #basePackageClasses()&#125; for a type-safe alternative to String-based package names.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Type-safe alternative to &#123;<span class="doctag">@link</span> #basePackages()&#125; for specifying the packages to scan for annotated components. The</span></span><br><span class="line"><span class="comment">	 * package of each class specified will be scanned. Consider creating a special no-op marker class or interface in</span></span><br><span class="line"><span class="comment">	 * each package that serves no purpose other than being referenced by this attribute.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Specifies which types are eligible for component scanning. Further narrows the set of candidate components from</span></span><br><span class="line"><span class="comment">	 * everything in &#123;<span class="doctag">@link</span> #basePackages()&#125; to everything in the base packages that matches the given filter or filters.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Filter[] includeFilters() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Specifies which types are not eligible for component scanning.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Filter[] excludeFilters() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the postfix to be used when looking up custom repository implementations. Defaults to &#123;<span class="doctag">@literal</span> Impl&#125;. So</span></span><br><span class="line"><span class="comment">	 * for a repository named &#123;<span class="doctag">@code</span> PersonRepository&#125; the corresponding implementation class will be looked up scanning</span></span><br><span class="line"><span class="comment">	 * for &#123;<span class="doctag">@code</span> PersonRepositoryImpl&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">repositoryImplementationPostfix</span><span class="params">()</span> <span class="keyword">default</span> "Impl"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configures the location of where to find the Spring Data named queries properties file. Will default to</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> META-INFO/mongo-named-queries.properties&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">namedQueriesLocation</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the key of the &#123;<span class="doctag">@link</span> QueryLookupStrategy&#125; to be used for lookup queries for query methods. Defaults to</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> Key#CREATE_IF_NOT_FOUND&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">Key <span class="title">queryLookupStrategy</span><span class="params">()</span> <span class="keyword">default</span> Key.CREATE_IF_NOT_FOUND</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the &#123;<span class="doctag">@link</span> FactoryBean&#125; class to be used for each repository instance. Defaults to</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> MongoRepositoryFactoryBean&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt; repositoryFactoryBeanClass() <span class="keyword">default</span> MongoRepositoryFactoryBean.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configure the repository base class to be used to create repository proxies for this particular configuration.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt; repositoryBaseClass() <span class="keyword">default</span> DefaultRepositoryBaseClass.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configures the name of the &#123;<span class="doctag">@link</span> MongoTemplate&#125; bean to be used with the repositories detected.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">mongoTemplateRef</span><span class="params">()</span> <span class="keyword">default</span> "mongoTemplate"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Whether to automatically create indexes for query methods defined in the repository interface.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">createIndexesForQueryMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configures whether nested repository-interfaces (e.g. defined as inner classes) should be discovered by the</span></span><br><span class="line"><span class="comment">	 * repositories infrastructure.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">considerNestedRepositories</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><p></p><br></details>

<details><summary>EnableMongoRepositoriesConfiguration</summary><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableMongoRepositories</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableMongoRepositoriesConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><p></p><br></details>

<details><summary>RepositoryConfigurationExtension</summary><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RepositoryConfigurationExtension</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the descriptive name of the module.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getModuleName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all &#123;<span class="doctag">@link</span> RepositoryConfiguration&#125;s obtained through the given &#123;<span class="doctag">@link</span> RepositoryConfigurationSource&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> configSource must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> loader must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@deprecated</span> call or implement</span></span><br><span class="line"><span class="comment">	 *             &#123;<span class="doctag">@link</span> #getRepositoryConfigurations(RepositoryConfigurationSource, ResourceLoader, boolean)&#125; instead.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	&lt;T extends RepositoryConfigurationSource&gt; Collection&lt;RepositoryConfiguration&lt;T&gt;&gt; getRepositoryConfigurations(</span><br><span class="line">			T configSource, ResourceLoader loader);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all &#123;<span class="doctag">@link</span> RepositoryConfiguration&#125;s obtained through the given &#123;<span class="doctag">@link</span> RepositoryConfigurationSource&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> configSource</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> loader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> strictMatchesOnly whether to return strict repository matches only. Handing in &#123;<span class="doctag">@literal</span> true&#125; will cause</span></span><br><span class="line"><span class="comment">	 *          the repository interfaces and domain types handled to be checked whether they are managed by the current</span></span><br><span class="line"><span class="comment">	 *          store.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.9</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;T extends RepositoryConfigurationSource&gt; Collection&lt;RepositoryConfiguration&lt;T&gt;&gt; getRepositoryConfigurations(</span><br><span class="line">			T configSource, ResourceLoader loader, <span class="keyword">boolean</span> strictMatchesOnly);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the default location of the Spring Data named queries.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> must not be &#123;<span class="doctag">@literal</span> null&#125; or empty.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getDefaultNamedQueryLocation</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the name of the repository factory class to be used.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getRepositoryFactoryBeanClassName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to register additional bean definitions for a &#123;<span class="doctag">@literal</span> repositories&#125; root node. This usually includes</span></span><br><span class="line"><span class="comment">	 * beans you have to set up once independently of the number of repositories to be created. Will be called before any</span></span><br><span class="line"><span class="comment">	 * repositories bean definitions have been registered.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> source</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerBeansForRoot</span><span class="params">(BeanDefinitionRegistry registry, RepositoryConfigurationSource configurationSource)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to post process the &#123;<span class="doctag">@link</span> BeanDefinition&#125; and tweak the configuration if necessary.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> config will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcess</span><span class="params">(BeanDefinitionBuilder builder, RepositoryConfigurationSource config)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to post process the &#123;<span class="doctag">@link</span> BeanDefinition&#125; built from annotations and tweak the configuration if</span></span><br><span class="line"><span class="comment">	 * necessary.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> config will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcess</span><span class="params">(BeanDefinitionBuilder builder, AnnotationRepositoryConfigurationSource config)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to post process the &#123;<span class="doctag">@link</span> BeanDefinition&#125; built from XML and tweak the configuration if necessary.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> config will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcess</span><span class="params">(BeanDefinitionBuilder builder, XmlRepositoryConfigurationSource config)</span></span>;</span><br></pre></td></tr></table></figure><br><br><p></p><br></details>

<h3 id="初始化流程"><a href="#初始化流程" class="headerlink" title="初始化流程"></a>初始化流程</h3><h4 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h4><p>MongoRepositoriesAutoConfigureRegistrar的父类AbstractRepositoryConfigurationSourceSupport<br><strong>AbstractRepositoryConfigurationSourceSupport</strong>，该类主要实现了<a href="https://github.com/spring-projects/spring-framework/blob/28b2a4d46db39f7c6c25ba8a4ace825af3c4cbcb/spring-context/src/main/java/org/springframework/context/annotation/ImportBeanDefinitionRegistrar.java#L61" target="_blank" rel="noopener">ImportBeanDefinitionRegistrar</a>的registerBeanDefinitions方法，registerBeanDefinitions是Spring初始化的时候调用，让程序能够自主注册一些bean到spring容器里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span></span></span><br><span class="line"><span class="function"><span class="params">		BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">new</span> RepositoryConfigurationDelegate(getConfigurationSource(registry),</span><br><span class="line">			<span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.environment).registerRepositoriesIn(registry,</span><br><span class="line">					getRepositoryConfigurationExtension());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>registerBeanDefinitions. registerBeanDefinitions调用了RepositoryConfigurationDelegate.registerRepositoriesIn方法<br>这个方法包含了spring data mongo对于mongo repository的初始化的整个流程，主要逻辑是通过configurationSource（由EnableMongoRepositories构造），以及RepositoryConfigurationExtension扫描BasePackages下面的类，构造beanDefinition并且注册到spring registry。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers the found repositories in the given &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> extension</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> BeanComponentDefinition&#125;s for all repository bean definitions found.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BeanComponentDefinition&gt; <span class="title">registerRepositoriesIn</span><span class="params">(BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">		RepositoryConfigurationExtension extension)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	extension.registerBeansForRoot(registry, configurationSource);</span><br><span class="line"></span><br><span class="line">	RepositoryBeanDefinitionBuilder builder = <span class="keyword">new</span> RepositoryBeanDefinitionBuilder(registry, extension, resourceLoader,</span><br><span class="line">			environment);</span><br><span class="line">	List&lt;BeanComponentDefinition&gt; definitions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (RepositoryConfiguration&lt;? extends RepositoryConfigurationSource&gt; configuration : extension</span><br><span class="line">			.getRepositoryConfigurations(configurationSource, resourceLoader, inMultiStoreMode)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//BeanDefintion构造的主要逻辑</span></span><br><span class="line">		BeanDefinitionBuilder definitionBuilder = builder.build(configuration);</span><br><span class="line"></span><br><span class="line">		extension.postProcess(definitionBuilder, configurationSource);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isXml) &#123;</span><br><span class="line">			extension.postProcess(definitionBuilder, (XmlRepositoryConfigurationSource) configurationSource);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			extension.postProcess(definitionBuilder, (AnnotationRepositoryConfigurationSource) configurationSource);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		AbstractBeanDefinition beanDefinition = definitionBuilder.getBeanDefinition();</span><br><span class="line">		String beanName = configurationSource.generateBeanName(beanDefinition);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">			LOGGER.debug(REPOSITORY_REGISTRATION, extension.getModuleName(), beanName,</span><br><span class="line">					configuration.getRepositoryInterface(), configuration.getRepositoryFactoryBeanClassName());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		beanDefinition.setAttribute(FACTORY_BEAN_OBJECT_TYPE, configuration.getRepositoryInterface());</span><br><span class="line"></span><br><span class="line">		registry.registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">		definitions.add(<span class="keyword">new</span> BeanComponentDefinition(beanDefinition, beanName));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> definitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BeanDefinition构造"><a href="#BeanDefinition构造" class="headerlink" title="BeanDefinition构造"></a>BeanDefinition构造</h3><p>registerRepositoriesIn调用了RepositoryBeanDefinitionBuilder.build方法，注意到BeanDefinitionBuilder<br>                .rootBeanDefinition(configuration.getRepositoryFactoryBeanClassName())，这里把MongoRepositoryFactoryBean设置为BeanDefinition的class,意味着Bean的初始化由MongoRepositoryFactoryBean进行控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionBuilder <span class="title">build</span><span class="params">(RepositoryConfiguration&lt;?&gt; configuration)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.notNull(registry, <span class="string">"BeanDefinitionRegistry must not be null!"</span>);</span><br><span class="line">		Assert.notNull(resourceLoader, <span class="string">"ResourceLoader must not be null!"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//设置类为MongoRepositoryFactoryBean</span></span><br><span class="line">		BeanDefinitionBuilder builder = BeanDefinitionBuilder</span><br><span class="line">				.rootBeanDefinition(configuration.getRepositoryFactoryBeanClassName());</span><br><span class="line"></span><br><span class="line">		builder.getRawBeanDefinition().setSource(configuration.getSource());</span><br><span class="line">		builder.addConstructorArgValue(configuration.getRepositoryInterface());</span><br><span class="line">		builder.addPropertyValue(<span class="string">"queryLookupStrategyKey"</span>, configuration.getQueryLookupStrategyKey());</span><br><span class="line">		builder.addPropertyValue(<span class="string">"lazyInit"</span>, configuration.isLazyInit());</span><br><span class="line"></span><br><span class="line">		configuration.getRepositoryBaseClassName()<span class="comment">//</span></span><br><span class="line">				.ifPresent(it -&gt; builder.addPropertyValue(<span class="string">"repositoryBaseClass"</span>, it));</span><br><span class="line"></span><br><span class="line">		NamedQueriesBeanDefinitionBuilder definitionBuilder = <span class="keyword">new</span> NamedQueriesBeanDefinitionBuilder(</span><br><span class="line">				extension.getDefaultNamedQueryLocation());</span><br><span class="line">		configuration.getNamedQueriesLocation().ifPresent(definitionBuilder::setLocations);</span><br><span class="line"></span><br><span class="line">		builder.addPropertyValue(<span class="string">"namedQueries"</span>, definitionBuilder.build(configuration.getSource()));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//2.0版本已经不建议使用的方法，和Framement类似</span></span><br><span class="line">		registerCustomImplementation(configuration).ifPresent(it -&gt; &#123;</span><br><span class="line">			builder.addPropertyReference(<span class="string">"customImplementation"</span>, it);</span><br><span class="line">			builder.addDependsOn(it);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		BeanDefinitionBuilder fragmentsBuilder = BeanDefinitionBuilder</span><br><span class="line">				.rootBeanDefinition(RepositoryFragmentsFactoryBean.class);</span><br><span class="line"></span><br><span class="line">		List&lt;String&gt; fragmentBeanNames = registerRepositoryFragmentsImplementation(configuration) <span class="comment">//</span></span><br><span class="line">				.map(RepositoryFragmentConfiguration::getFragmentBeanName) <span class="comment">//</span></span><br><span class="line">				.collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">		fragmentsBuilder.addConstructorArgValue(fragmentBeanNames);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//注册Fragmemnt,也就是这种做法</span></span><br><span class="line">		<span class="comment">//https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#repositories.custom-implementations</span></span><br><span class="line">		builder.addPropertyValue(<span class="string">"repositoryFragments"</span>,</span><br><span class="line">				ParsingUtils.getSourceBeanDefinition(fragmentsBuilder, configuration.getSource()));</span><br><span class="line"></span><br><span class="line">		RootBeanDefinition evaluationContextProviderDefinition = <span class="keyword">new</span> RootBeanDefinition(</span><br><span class="line">				ExtensionAwareEvaluationContextProvider.class);</span><br><span class="line">		evaluationContextProviderDefinition.setSource(configuration.getSource());</span><br><span class="line"></span><br><span class="line">		builder.addPropertyValue(<span class="string">"evaluationContextProvider"</span>, evaluationContextProviderDefinition);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> builder;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MongoRepositoryFactoryBean"><a href="#MongoRepositoryFactoryBean" class="headerlink" title="MongoRepositoryFactoryBean"></a>MongoRepositoryFactoryBean</h3><p>MongoRepositoriesAutoConfigureRegistrar的职责最终就是把所有扫到的Repository构造成BeanDefinition注册到Registry, BeanDefinition的BaseClass是MongoRepositoryFactoryBean，所以该FactoryBean是spring data mongo的核心。</p>
<p>从该Sequence Diagram可以看出Repository最终的实现是通过Proxy,这里只列出了两个关键的Interceptor</p>
<ol>
<li>QueryExecutorMethodInterceptor - 该类主要实现了<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#mongodb.repositories.queries" target="_blank" rel="noopener">Query methods</a></li>
<li>ImplementationMethodExecutionInterceptor - 该类主要实现了<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#repositories.custom-implementations" target="_blank" rel="noopener">repositories.custom-implementations</a></li>
</ol>
<p><strong>Sequence Diagram</strong></p>
<img src="http://www.plantuml.com/plantuml/svg/dP5D2eCm48NtdYBBTk45f1HgQS65q9yJ3F7L1ZG9oTZgxHkHKalHWgkGcNdVuyrOSgoaigHPv4QNvW9hl6BZkYF9_ab1EegcUoBUpYWJGJU6EpbZ4PpWh-18EX1ZGhN8AX4QpuLA3_vKK_BOL-JzGbWvXhs3XlJjdtWzSpms5-XtbefYLpoKnEhSm7M75h89dHnyDqMcmm4aR2Yi5n2psbQeePbO6JqW1uFm_MBFhMmJnvCx6oti1G00">
<p><strong>Class Diagram</strong></p>
<img src="http://www.plantuml.com/plantuml/svg/ZP193e8m58RNzXJT6pY22nDDM1372zJwm1fec_988CZTBKCK1QfB_kcLZmY9O2B6WMuPHsNADJ19UCAoZ8PAnke8McMYSSQ1IU-KQwqCqeeigaX0SgsfTwRc5RLo2dXJLb-oo5xV6wN1e83i13XqppG6t5tkm97KpZVrfbqglgH33gRS5C1pAuRjSj3yCWTjXJuKf3g152Go54fsgQvZFuVnDwtn59d7HJtliNBI8awKlc_hG_m_qgivJDDos_XWvyZz0Efe_atPVQAZCRxyx_nS_ma0">
<h3 id="QueryExecutorMethodInterceptor"><a href="#QueryExecutorMethodInterceptor" class="headerlink" title="QueryExecutorMethodInterceptor"></a>QueryExecutorMethodInterceptor</h3><p>从该Sequence Diagram可看出QueryExecutorMethodInterceptor最终构造了PartTree，PartTree又Predicate组成</p>
<h4 id="Sequence-Diagram"><a href="#Sequence-Diagram" class="headerlink" title="Sequence Diagram"></a>Sequence Diagram</h4><img src="http://www.plantuml.com/plantuml/svg/umeiJIsgTAr8JIujoI_oJIt9o4_np2j9BKfEBG0AAEZQAVZcvwNdWvNvvETdbnO4bnGbbgIcLreLfHRdvvIbWgMuaejIWQ8A0Ob59I55gQa8JLouz8FCnbHkfP2NMevk6XUcEcJTg7gAKbCoau4ik2QmKfWeH2q0">
<h4 id="Class-Diagram"><a href="#Class-Diagram" class="headerlink" title="Class Diagram"></a>Class Diagram</h4><img src="http://www.plantuml.com/plantuml/svg/XP3D3i8W48JlF0Ld3po01suUJ6pyVG52rqeqNRA5n2O-l2sKrYYjjs6OcKq-KpkWgzB0ZnwetI7UlJqxKWwgbkc7QXfUO5rXxjkCvHDOR8n3QaDkA1uKkGi1J0CVbGBS3Sjj_zPWk-fG2hdD4xJllBbGMcRBQIx4IsOk_Mt970xEvaZ4Epb4lmXYzXlOmhBCSSpiheIOk2GHNOBIw6wFZIhuU-fZVCrhDiYq4Rmt">
<h3 id="PartTree"><a href="#PartTree" class="headerlink" title="PartTree"></a>PartTree</h3><p><a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L84" target="_blank" rel="noopener">PartTree</a>首先通过方法名(source参数)解析出语句类型（查询/更新/删除），然后把余下的部分传给了Predicate, 例如findByAuthorOrTitle(以下的解析把这个方法名作为例子），那么传给Predicate的就是<strong>AuthorOrTitle</strong></p>
<p>下面这些静态变量则是定义了合法的方法名前缀，从这些变量可知道查询方法的前缀不仅仅只支持“find”,😊同时也支持“read/get/query/steam”.这些可在官方文档没提及。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEYWORD_TEMPLATE = <span class="string">"(%s)(?=(\\p&#123;Lu&#125;|\\P&#123;InBASIC_LATIN&#125;))"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUERY_PATTERN = <span class="string">"find|read|get|query|stream"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COUNT_PATTERN = <span class="string">"count"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXISTS_PATTERN = <span class="string">"exists"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELETE_PATTERN = <span class="string">"delete|remove"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PREFIX_TEMPLATE = Pattern.compile( <span class="comment">//</span></span><br><span class="line">		<span class="string">"^("</span> + QUERY_PATTERN + <span class="string">"|"</span> + COUNT_PATTERN + <span class="string">"|"</span> + EXISTS_PATTERN + <span class="string">"|"</span> + DELETE_PATTERN + <span class="string">")((\\p&#123;Lu&#125;.*?))??By"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PartTree</span><span class="params">(String source, Class&lt;?&gt; domainClass)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Assert.notNull(source, <span class="string">"Source must not be null"</span>);</span><br><span class="line">	Assert.notNull(domainClass, <span class="string">"Domain class must not be null"</span>);</span><br><span class="line"></span><br><span class="line">	Matcher matcher = PREFIX_TEMPLATE.matcher(source);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!matcher.find()) &#123;</span><br><span class="line">		<span class="keyword">this</span>.subject = <span class="keyword">new</span> Subject(Optional.empty());</span><br><span class="line">		<span class="keyword">this</span>.predicate = <span class="keyword">new</span> Predicate(source, domainClass);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.subject = <span class="keyword">new</span> Subject(Optional.of(matcher.group(<span class="number">0</span>)));</span><br><span class="line">		<span class="keyword">this</span>.predicate = <span class="keyword">new</span> Predicate(source.substring(matcher.group().length()), domainClass);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h3><p>那么<a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L361" target="_blank" rel="noopener">Predicate</a>的逻辑又是怎样的呢？Predicate主要是根据repository的方法名，通过关键字“Or”，把方法名split成多个子字符串，构造OrPart, 多个OrPart最终在mongo的查询里就会解析成了$or.例如<strong>AuthorOrTitle</strong>就会被拆成<strong>Author</strong>和<strong>Title</strong>然后构造成两个OrPart对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Predicate</span><span class="params">(String predicate, Class&lt;?&gt; domainClass)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String[] parts = split(detectAndSetAllIgnoreCase(predicate), ORDER_BY);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (parts.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"OrderBy must not be used more than once in a method name!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.nodes = Arrays.stream(split(parts[<span class="number">0</span>], <span class="string">"Or"</span>)) <span class="comment">//</span></span><br><span class="line">			.filter(StringUtils::hasText) <span class="comment">//</span></span><br><span class="line">			.map(part -&gt; <span class="keyword">new</span> OrPart(part, domainClass, alwaysIgnoreCase)) <span class="comment">//</span></span><br><span class="line">			.collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.orderBySource = parts.length == <span class="number">2</span> ? <span class="keyword">new</span> OrderBySource(parts[<span class="number">1</span>], Optional.of(domainClass))</span><br><span class="line">					: OrderBySource.EMPTY;</span><br></pre></td></tr></table></figure>
<h3 id="OrPart"><a href="#OrPart" class="headerlink" title="OrPart"></a>OrPart</h3><p>从<a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L233" target="_blank" rel="noopener">OrPart</a>的构造函数可以看出，这里是把Source拆成构造成List\&lt;Part>,以<strong>Author</strong>作为例子，由于也不包含”And”,所以只会有一个Part对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OrPart(String source, Class&lt;?&gt; domainClass, <span class="keyword">boolean</span> alwaysIgnoreCase) &#123;</span><br><span class="line"></span><br><span class="line">	String[] split = split(source, <span class="string">"And"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.children = Arrays.stream(split)<span class="comment">//</span></span><br><span class="line">			.filter(StringUtils::hasText)<span class="comment">//</span></span><br><span class="line">			.map(part -&gt; <span class="keyword">new</span> Part(part, domainClass, alwaysIgnoreCase))<span class="comment">//</span></span><br><span class="line">			.collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Part"><a href="#Part" class="headerlink" title="Part"></a>Part</h3><p><a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/Part.java#L69" target="_blank" rel="noopener">Part</a>主要设置了两个成员变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Part</span><span class="params">(String source, Class&lt;?&gt; clazz, <span class="keyword">boolean</span> alwaysIgnoreCase)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.hasText(source, <span class="string">"Part source must not be null or empty!"</span>);</span><br><span class="line">		Assert.notNull(clazz, <span class="string">"Type must not be null!"</span>);</span><br><span class="line"></span><br><span class="line">		String partToUse = detectAndSetIgnoreCase(source);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (alwaysIgnoreCase &amp;&amp; ignoreCase != IgnoreCaseType.ALWAYS) &#123;</span><br><span class="line">			<span class="keyword">this</span>.ignoreCase = IgnoreCaseType.WHEN_POSSIBLE;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.type = Type.fromProperty(partToUse);</span><br><span class="line">		<span class="keyword">this</span>.propertyPath = PropertyPath.from(type.extractProperty(partToUse), clazz);</span><br><span class="line">	&#125;</span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. [type](https:<span class="comment">//github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/Part.java#L149) - 主要保存了该条件的类型，BETWEEN, IS_NOT_NULL等等， 对于例子中的**author**关键字，则会解析为Type.SIMPLE_PROPERTY,表示EQUAL.</span></span><br><span class="line"><span class="number">2</span>. propertyPath - 属性名， **author**</span><br><span class="line"></span><br><span class="line">**看到这里，初始化的逻辑基本完毕， Repository的方法最终会被解析并且保存成PartTree, 查询的时候只需要从PartTree生成mongo语句**</span><br><span class="line"></span><br><span class="line">### MongoQueryCreator</span><br><span class="line">[MongoQueryCreator](https:<span class="comment">//github.com/spring-projects/spring-data-mongodb/blob/17d61004261c388a98bf1cc932318db69073db2f/spring-data-mongodb/src/main/java/org/springframework/data/mongodb/repository/query/MongoQueryCreator.java#L174)从该方法可看出从Part构建出Criteria的过程。</span></span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="function"><span class="keyword">private</span> Criteria <span class="title">from</span><span class="params">(Part part, MongoPersistentProperty property, Criteria criteria, Iterator&lt;Object&gt; parameters)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Type type = part.getType();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (type) &#123;</span><br><span class="line">		<span class="keyword">case</span> AFTER:</span><br><span class="line">		<span class="keyword">case</span> GREATER_THAN:</span><br><span class="line">			<span class="keyword">return</span> criteria.gt(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> GREATER_THAN_EQUAL:</span><br><span class="line">			<span class="keyword">return</span> criteria.gte(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> BEFORE:</span><br><span class="line">		<span class="keyword">case</span> LESS_THAN:</span><br><span class="line">			<span class="keyword">return</span> criteria.lt(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> LESS_THAN_EQUAL:</span><br><span class="line">			<span class="keyword">return</span> criteria.lte(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> BETWEEN:</span><br><span class="line">			<span class="keyword">return</span> criteria.gt(parameters.next()).lt(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> IS_NOT_NULL:</span><br><span class="line">			<span class="keyword">return</span> criteria.ne(<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">case</span> IS_NULL:</span><br><span class="line">			<span class="keyword">return</span> criteria.is(<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">case</span> NOT_IN:</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>扫描路径下继承Repository的接口（当有多个spring data模块存在时，则会限定到MongoRepository)的类生成代理。</li>
<li>解析接口名生成PartTree,执行的时候根据对应PartTree生成Criteria条件，传给MongoTemplate.</li>
</ol>
<h1 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h1><ol>
<li>😆看源码过程中发现<a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/core/support/SurroundingTransactionDetectorMethodInterceptor.java#L35" target="_blank" rel="noopener">SurroundingTransactionDetectorMethodInterceptor</a>枚举类可继承接口 </li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/Druid连接池获取超时问题解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员，川流不息">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/Druid连接池获取超时问题解决/" itemprop="url">Druid连接池获取超时问题解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T08:45:02+08:00">
                2018-04-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/03/Druid连接池获取超时问题解决/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/03/Druid连接池获取超时问题解决/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>线上某台机器出现频繁的获取mysql连接超时</p>
<h2 id="排查步骤"><a href="#排查步骤" class="headerlink" title="排查步骤"></a>排查步骤</h2><ol>
<li><p>通过日志可以看出服务时获取连接池超时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2017-07-14 13:10:01,973 [DubboServerHandler-10.25.65.225:20900-thread-174] ERROR com.alibaba.dubbo.rpc.filter.ExceptionFilter (ExceptionFilter.java:87) -  [DUBBO] Got unchecked and undeclared exception which called by 10.25.68.15. service: com.bilin.user.dynamic.service.IUserDynamicService, method: queryNewestDynamicMsgByUser, exception: org.springframework.jdbc.CannotGetJdbcConnectionException: Could not get JDBC Connection; nested exception is com.alibaba.druid.pool.GetConnectionTimeoutException: wait millis 10000, active 0, dubbo version: 2.4.9, current host: 10.25.65.225</span><br><span class="line">org.springframework.jdbc.CannotGetJdbcConnectionException: Could not get JDBC Connection; nested exception is com.alibaba.druid.pool.GetConnectionTimeoutException: wait millis 10000, active 0</span><br><span class="line">        at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:82)</span><br><span class="line">        at org.springframework.orm.ibatis.SqlMapClientTemplate.execute(SqlMapClientTemplate.java:183)</span><br><span class="line">        at org.springframework.orm.ibatis.SqlMapClientTemplate.executeWithListResult(SqlMapClientTemplate.java:220)</span><br><span class="line">        at org.springframework.orm.ibatis.SqlMapClientTemplate.queryForList(SqlMapClientTemplate.java:267)</span><br><span class="line">        at com.bilin.sdk.dao.base.BaseDAO.queryForList(BaseDAO.java:27)</span><br><span class="line">Caused by: com.alibaba.druid.pool.GetConnectionTimeoutException: wait millis 10000, active 0</span><br><span class="line">        at com.alibaba.druid.pool.DruidDataSource.getConnectionInternal(DruidDataSource.java:1071)</span><br><span class="line">        at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:898)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:4544)</span><br><span class="line">        at com.alibaba.druid.filter.stat.StatFilter.dataSource_getConnection(StatFilter.java:661)</span><br></pre></td></tr></table></figure>
</li>
<li><p>猜测可能的原因</p>
<ul>
<li>并发量太高<br>从数据上看，每秒不到1k请求，后端mysql服务器的负载也不高，所以这个原因基本排除</li>
<li>连接池连接数设置过低<br>业务设置的minIdel 100, maxConnection 300, 所以这个原因基本排除。</li>
<li>mysql服务故障<br>部署在别的机器上的服务，还有使用同一个db实例的其它业务没出现异常情况，所以这原因概率不大</li>
<li>mysql链接设置过低</li>
</ul>
</li>
<li><p>由于没有比较明显的可能性，所以只能看下源码(版本1.0.5)找下具体的原因。<br><a href="https://github.com/alibaba/druid/blob/1.0.5/src/main/java/com/alibaba/druid/pool/DruidDataSource.java" target="_blank" rel="noopener">DruidDataSource</a><br>异常的抛出是在1071行<br><a href="https://github.com/alibaba/druid/blob/1.0.5/src/main/java/com/alibaba/druid/pool/DruidDataSource.java#L1071" target="_blank" rel="noopener">throw new GetConnectionTimeoutException(errorMessage);</a><br>由于设置了链接获取的超时时间</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"10000"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时由报错的日志可知，连接等待了10秒获取失败，所以可得知执行的方法时pollLast</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (maxWait &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    holder = pollLast(nanos); <span class="comment">//L 1021</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    holder = takeLast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>druid的连接获取，是通过notEmpty和empty两个变量协调线程的同步，pollLast发现没可用连接时，就会notEmpty.await(),同时empty.signal().  emtpy.signal主要唤醒了CreateConnectionThread. 通过了解CreateConnectionThread的源码，发现在某些情况下线程会退出。<br><strong>情况1</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    connection = createPhysicalConnection();</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"create connection error"</span>, e);</span><br><span class="line"></span><br><span class="line">    errorCount++;</span><br><span class="line">    <span class="comment">//当错误次数达到设置值时，breakAfterAcquireFailure设置为true时线程会退出</span></span><br><span class="line">    <span class="keyword">if</span> (errorCount &gt; connectionErrorRetryAttempts &amp;&amp; timeBetweenConnectErrorMillis &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (breakAfterAcquireFailure) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(timeBetweenConnectErrorMillis);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException interruptEx) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"create connection error"</span>, e);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Error e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"create connection error"</span>, e);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>情况2</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DruidConnectionHolder holder = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    holder = <span class="keyword">new</span> DruidConnectionHolder(DruidDataSource.<span class="keyword">this</span>, connection);</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">    <span class="comment">//这里也会退出</span></span><br><span class="line">    LOG.error(<span class="string">"create connection holder error"</span>, ex);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>情况1由于在该项目中没设置breakAfterAcquireFailure，采用默认值false,所以情况1不大可能出现，Error属于不可恢复错误，所以退出也合理。<br>情况2就有点不合理，单个的SQLException也会导致整个的生存线程结束。</p>
<ol start="4">
<li>所以接下来主要是确认CreateConnectionThread是否存在异常<br>通过jstack grep线程名Druid-ConnectionPool-Create（线程有设置线程名是个好习惯）,从grep的结果，发现存在一个CreateConnectionThread，由于业务设置了两个连接池，所以一个是不正常<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo -u www-data jstack 10750  | grep "Druid-ConnectionPool-Create"</span></span><br><span class="line"><span class="string">"Druid-ConnectionPool-Create-376416626"</span> daemon prio=10 tid=0x00007faab4039800 nid=0x2ae3 waiting on condition [0x00007faac3ec6000]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>继续grep一下Destroy线程，确认是两个线程，所以Destroy线程正常，进一步确认了CreateConnectionThread线程存在问题。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo -u www-data jstack 10750  | grep "Druid-ConnectionPool-Des"</span></span><br><span class="line"><span class="string">"Druid-ConnectionPool-Destory-376416626"</span> daemon prio=10 tid=0x00007faab403a800 nid=0x2ae4 waiting on condition [0x00007faac3e85000]</span><br><span class="line"><span class="string">"Druid-ConnectionPool-Destory-190586441"</span> daemon prio=10 tid=0x00007faad8fb1800 nid=0x2a3d waiting on condition [0x00007faac9dda000]</span><br></pre></td></tr></table></figure></p>
<ol start="5">
<li><p>基本确认了是由于CreateConnectionThread不正常结束，所以最后一步就是找寻证据证明线程不正常的结束。通过以上源码，可看到Druid在每一步的异常处理都会记录日志，所以通过日志关键字进行grep,发现在1682行写了个错误日志，<strong>对应到的正式线程退出情况2</strong>.所以问题的原因就是druid在获取mysql连接后创建DruidConnectionHolder时由于网络原因报了MySQLException导致了CreateConnectionThread退出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">2017-07-14 00:26:59,609 [Druid-ConnectionPool-Create-190586441] ERROR com.alibaba.druid.pool.DruidDataSource<span class="variable">$CreateConnectionThread</span> (DruidDataSource.java:1682) - create connection holder error</span><br><span class="line">com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure</span><br><span class="line">The last packet successfully received from the server was 0 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ago.</span><br><span class="line">        at sun.reflect.GeneratedConstructorAccessor33.newInstance(Unknown Source)</span><br><span class="line">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">        at java.lang.reflect.Constructor.newInstance(Constructor.java:525)</span><br><span class="line">        at com.mysql.jdbc.Util.handleNewInstance(Util.java:411)</span><br><span class="line">        at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:1121)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3673)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3562)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4113)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2570)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2731)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2812)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2761)</span><br><span class="line">        at com.mysql.jdbc.StatementImpl.executeQuery(StatementImpl.java:1612)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.getTransactionIsolation(ConnectionImpl.java:3352)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.connection_getTransactionIsolation(FilterChainImpl.java:347)</span><br><span class="line">        at com.alibaba.druid.filter.FilterAdapter.connection_getTransactionIsolation(FilterAdapter.java:872)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.connection_getTransactionIsolation(FilterChainImpl.java:344)</span><br><span class="line">        at com.alibaba.druid.filter.FilterAdapter.connection_getTransactionIsolation(FilterAdapter.java:872)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.connection_getTransactionIsolation(FilterChainImpl.java:344)</span><br><span class="line">        at com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl.getTransactionIsolation(ConnectionProxyImpl.java:260)</span><br><span class="line">        at com.alibaba.druid.pool.DruidConnectionHolder.&lt;init&gt;(DruidConnectionHolder.java:92)</span><br><span class="line">        at com.alibaba.druid.pool.DruidDataSource<span class="variable">$CreateConnectionThread</span>.run(DruidDataSource.java:1680)</span><br><span class="line">Caused by: java.net.SocketException: Connection reset</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:189)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:121)</span><br><span class="line">        at com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:114)</span><br><span class="line">        at com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:161)</span><br><span class="line">        at com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:189)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:3116)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3573)</span><br><span class="line">        ... 16 more</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看了最新版本1.1.2这部分的代码，发现这部分代码已经重构了，不存在该问题，所以升级版本即可。</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>故障的版本时1.0.5，发布于2014年，属于比较旧的版本，开源工具不可避免的会存在bug,所以需要即时的进行升级</li>
<li>使用开源工具时，尽可能的使用最新的版本。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://static.qqdaxia.com/rimg/hs/240_240_/t013e4fa6f38b1cece5.jpg" alt="HongShuwei">
            
              <p class="site-author-name" itemprop="name">HongShuwei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:hongshuwei@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HongShuwei</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://hoswey.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
