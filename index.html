<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/24/Spring-Rabbitmq-bugæ’æŸ¥/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/24/Spring-Rabbitmq-bugæ’æŸ¥/" itemprop="url">Spring - Rabbitmq bugæ’æŸ¥</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-04-24T09:35:23+08:00">
                2018-04-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/24/Spring-Rabbitmq-bugæ’æŸ¥/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/24/Spring-Rabbitmq-bugæ’æŸ¥/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>é¡¹ç›®åŒæ—¶è¿æ¥å¤šä¸ªrabbitmq,ä½¿ç”¨spring-rabbitè¿›è¡Œè¿æ¥ï¼Œç‰ˆæœ¬å·ä¸º1.4.6.RELEASE</p>
<p>æŸå¤©å‘ç°rabbitmqæœåŠ¡å™¨æ—¥å¿—é”™è¯¯æ—¥å¿—å‡ºç°å¤§é‡</p>
<blockquote>
<p>Channel error on connection &lt;0.3019.46&gt; (1.1.1.1:41724 -&gt; 1.2.3.4:5672, vhost: â€˜/â€˜, user: â€˜xunhuan_prodâ€™), channel 31: operation queue.declare caused a channel exception not_found: â€œno queue â€˜wolfkill.groups.online.time.queueâ€™ in vhost â€˜/â€˜â€œ</p>
</blockquote>
<h3 id="rabbitmqæ¶æ„"><a href="#rabbitmqæ¶æ„" class="headerlink" title="rabbitmqæ¶æ„"></a>rabbitmqæ¶æ„</h3><p>ä¸¤ä¸ªrabbitmqé›†ç¾¤ï¼Œä½¿ç”¨ä¸åŒçš„virtual host</p>
<table>
<thead>
<tr>
<th>é›†ç¾¤</th>
<th>Virtual Host</th>
<th>Queue</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>service_A</td>
<td>A1, A2</td>
</tr>
<tr>
<td>B</td>
<td>/</td>
<td>wolfkill.groups.online.time.queue</td>
</tr>
</tbody>
</table>
<h2 id="æ•…éšœæ’æŸ¥"><a href="#æ•…éšœæ’æŸ¥" class="headerlink" title="æ•…éšœæ’æŸ¥"></a>æ•…éšœæ’æŸ¥</h2><h3 id="æ£€æŸ¥spring-xmlé…ç½®æ–‡ä»¶"><a href="#æ£€æŸ¥spring-xmlé…ç½®æ–‡ä»¶" class="headerlink" title="æ£€æŸ¥spring xmlé…ç½®æ–‡ä»¶"></a>æ£€æŸ¥spring xmlé…ç½®æ–‡ä»¶</h3><ul>
<li>ä¸¤ä¸ªrabbitmqé…ç½®éƒ½å·²ç»åˆ†å¼€</li>
<li>queueå’Œexchangeéƒ½å…¨éƒ¨åŠ ä¸Šäº†<a href="https://docs.spring.io/spring-amqp/reference/htmlsingle/#conditional-declaration" target="_blank" rel="noopener">declared-by</a></li>
</ul>
<h3 id="æ£€æŸ¥æºä»£ç "><a href="#æ£€æŸ¥æºä»£ç " class="headerlink" title="æ£€æŸ¥æºä»£ç "></a>æ£€æŸ¥æºä»£ç </h3><h4 id="SimpleMessageListenerContainer"><a href="#SimpleMessageListenerContainer" class="headerlink" title="SimpleMessageListenerContainer"></a>SimpleMessageListenerContainer</h4><p>åˆå§‹åŒ–çš„æ—¶å€™åˆ¤æ–­å½“å‰RabbitAdminçš„æ•°é‡ï¼Œå‡å¦‚ä¸ä¸ºç©ºçš„è¯ï¼Œå°±èµ‹å€¼ç»™æˆå‘˜å˜é‡RabbitAdmin,çœ‹åˆ°è¿™é‡Œæ—¶å·²ç»æ„Ÿè§‰æœ‰ç‚¹ä¸å¦¥ï¼Œè¿™ä¹Ÿå¤ªè¿‡éšæ„äº†å§ğŸ˜®ï¼Œè¯¥é¡¹ç›®æ¥å…¥äº†ä¸¤ä¸ªmq,æ‰€ä»¥RabbitAdminå¯¹åº”ç€æœ‰ä¸¤ä¸ªã€‚<br><a href="https://github.com/spring-projects/spring-amqp/blob/f9586b5de7e852033a5ece2cb229f3cac740e053/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java#L685" target="_blank" rel="noopener">æºä»£ç ä¼ é€é—¨</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.doStart();</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.rabbitAdmin == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.getApplicationContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="comment">//åˆå§‹åŒ–æ—¶ä¼šéšæœºæ‹¿ç¬¬ä¸€ä¸ªRabbitAdminè®¾ç½®ä¸ºå½“å‰çš„å˜é‡ä»¥ä¾›åç»­ä½¿ç”¨ï¼Œä½†å½“é¡¹ç›®æœ‰å¤šä¸ªRabbitAdminæ—¶åˆ™å¯èƒ½è®¾ç½®é”™è¯¯</span></span><br><span class="line">		Map&lt;String, RabbitAdmin&gt; admins = <span class="keyword">this</span>.getApplicationContext().getBeansOfType(RabbitAdmin.class);</span><br><span class="line">		<span class="keyword">if</span> (!admins.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.rabbitAdmin = admins.values().iterator().next();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨doStartä¹‹åæ‰§è¡Œçš„ä»£ç ï¼Œæ‹¿äº†ä¸ç¡®å®šçš„RabbitAdminç»§ç»­declare Queue(è°ƒç”¨Rabbitmq Broker api).<br><a href="https://github.com/spring-projects/spring-amqp/blob/f9586b5de7e852033a5ece2cb229f3cac740e053/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java#L963" target="_blank" rel="noopener">æºä»£ç ä¼ é€é—¨</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">redeclareElementsIfNecessary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		ApplicationContext applicationContext = <span class="keyword">this</span>.getApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (applicationContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">			Set&lt;String&gt; queueNames = <span class="keyword">this</span>.getQueueNamesAsSet();</span><br><span class="line">			Map&lt;String, Queue&gt; queueBeans = applicationContext.getBeansOfType(Queue.class);</span><br><span class="line">			<span class="keyword">for</span> (Entry&lt;String, Queue&gt; entry : queueBeans.entrySet()) &#123;</span><br><span class="line">				Queue queue = entry.getValue();</span><br><span class="line">				<span class="comment">//rabbitAdmin.getQueuePropertiesä¼šè°ƒç”¨channel.queueDeclarePassive,æ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¼šæ‹¿äº†é”™è¯¯çš„RabbitAdminè¿›è¡Œåˆ›å»ºï¼Œæ‰€ä»¥è¯¥å¤„æ˜¯é—®é¢˜æ‰€åœ¨</span></span><br><span class="line">				<span class="keyword">if</span> (queueNames.contains(queue.getName()) &amp;&amp;</span><br><span class="line">						<span class="keyword">this</span>.rabbitAdmin.getQueueProperties(queue.getName()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"At least one queue is missing: "</span> + queue.getName()</span><br><span class="line">								+ <span class="string">"; redeclaring context exchanges, queues, bindings."</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">this</span>.rabbitAdmin.initialize();</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ£€æŸ¥æ–°ç‰ˆæœ¬ä»£ç "><a href="#æ£€æŸ¥æ–°ç‰ˆæœ¬ä»£ç " class="headerlink" title="æ£€æŸ¥æ–°ç‰ˆæœ¬ä»£ç "></a>æ£€æŸ¥æ–°ç‰ˆæœ¬ä»£ç </h4><p><a href="https://github.com/spring-projects/spring-amqp/blob/233aa11cf9046fb8c2c3c5a373d09d9e645aa2b3/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/listener/SimpleMessageListenerContainer.java#L801" target="_blank" rel="noopener">æºä»£ç ä¼ é€é—¨</a></p>
<p>æ£€æŸ¥æœ€æ–°çš„ç‰ˆæœ¬1.7.3.RELEASE, æœ€æ–°ç‰ˆæœ¬å·²ç»åŠ äº†æ¡ä»¶åˆ¤æ–­ï¼Œå½“åªæœ‰ä¸€ä¸ªRabbitAdminæ—¶æ‰ä¼šè®¾ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.rabbitAdmin == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.getApplicationContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		Map&lt;String, RabbitAdmin&gt; admins = <span class="keyword">this</span>.getApplicationContext().getBeansOfType(RabbitAdmin.class);</span><br><span class="line">		<span class="keyword">if</span> (admins.size() == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.rabbitAdmin = admins.values().iterator().next();</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ‰€ä»¥è¯¥é—®é¢˜çš„åŸå› æ˜¯spring rabbitmqåœ¨é¡¹ç›®åŒæ—¶å­˜åœ¨å¤šä¸ªRabbitAdminæ—¶ï¼Œè¯¯ç”¨äº†RabbitAdmin, RabbitAdminå°±æ˜¯åˆ†åˆ«å¯¹åº”ç€ä¸åŒçš„Rabbitmqé›†ç¾¤ï¼Œåœ¨è¯¥åœºæ™¯ä¸‹ï¼Œç”¨äº†RabbitAdmin Aå»åˆ›å»ºåŸæœ¬åº”è¯¥åˆ›å»ºåœ¨Bä¸Šçš„Virtual Hostä¸ºâ€œ/â€çš„Queueâ€wolfkill.groups.online.time.queueâ€.</strong></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>è¯¥é—®é¢˜æ˜¯spring-rabbitmqæ¨¡å—çš„bug,æç‰ˆæœ¬å·²ç»è§£å†³</li>
<li>ä½¿ç”¨å¼€æºå·¥å…·æ—¶ï¼Œå°½å¯èƒ½çš„ä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬ã€‚</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/04/spring-data-mongoæºç è§£æ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/04/spring-data-mongoæºç è§£æ/" itemprop="url">spring-data-mongoæºç è§£æ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-04-04T09:50:00+08:00">
                2018-04-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/04/spring-data-mongoæºç è§£æ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/04/spring-data-mongoæºç è§£æ/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç”±äºé¡¹ç›®å·²ç»å¾ˆé‡çš„ä½¿ç”¨äº†mongodb, å¯¹äºmongodbçš„è®¿é—®ä¸»è¦é‡‡ç”¨<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/" target="_blank" rel="noopener">spring-data-mongo</a>,è¯¥æ¡†æ¶å¯¹äºä¸€äº›ç®€å•çš„æŸ¥è¯¢è¯­å¥éƒ½èƒ½ç›´æ¥é€šè¿‡<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#mongodb.repositories.queries" target="_blank" rel="noopener">Query methods</a>,éœ€è¦æ‰‹å·¥å†™æŸ¥è¯¢è¯­å¥çš„æƒ…å†µä¹Ÿå¾ˆå°‘ï¼Œè¿™ç§magicèˆ¬çš„ä½¿ç”¨æ–¹æ³•ä¹Ÿå¼•èµ·äº†æˆ‘çš„å¥½å¥‡ï¼Œä»¥å‰å†™æŸ¥è¯¢è¯­å¥çš„æ—¶å€™è§„èŒƒä¹Ÿæ˜¯è¯´ï¼Œå¯¹äºè¿›è¡ŒsqlæŸ¥è¯¢çš„æ–¹æ³•åº”å½“å’ŒæŸ¥è¯¢çš„æ¡ä»¶ä¿æŒä¸€è‡´ï¼Œä¾‹å¦‚findByXXXä¹‹ç±»ï¼Œæ²¡æƒ³åˆ°spring dataåªéœ€è¦æŒ‰ç…§ç±»ä¼¼è¿™ç§è§„èŒƒï¼Œå°±èƒ½ç›´æ¥ç”Ÿæˆå¯¹åº”çš„æŸ¥è¯¢è¯­å¥ï¼Œé‚£ä¹ˆåº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</p>
<h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h2><p>äº†è§£springæ¥å£ç±»æ–¹æ³•çš„åŸç†ã€‚</p>
<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>é€šè¿‡spring bootå¿«é€Ÿæ­å»º<a href="https://github.com/hoswey/example-spring-data-mongo.git" target="_blank" rel="noopener">demo</a>,è¯¥demoåŒ…å«ä¸€ä¸ªMongoRepository,é€šè¿‡mainå‡½æ•°æ‰§è¡Œä¸€äº›ç®€å•çš„æŸ¥è¯¢æ–¹æ³•ã€‚</p>
<p><a href="https://github.com/hoswey/example-spring-data-mongo/blob/master/src/main/java/com/example/spring/mongo/demo/repository/ArticleRepository.java" target="_blank" rel="noopener">ArticleRepositroy</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ— éœ€ä»»ä½•å®ç°ï¼Œä½¿ç”¨findByAuthoræ—¶ï¼Œspring dataä¼šè‡ªåŠ¨ç”ŸæˆmongodbæŸ¥è¯¢è¯­å¥</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArticleRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Article</span>, <span class="title">String</span>&gt;,</span></span><br><span class="line"><span class="class">    <span class="title">CustomizedArticleRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">List&lt;Article&gt; <span class="title">findByAuthorOrderByIdDescAllIgnoreCase</span><span class="params">(String author)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">List&lt;Article&gt; <span class="title">findByNumOfLikeIsGreaterThan</span><span class="params">(<span class="keyword">int</span> numOfLike)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="Spring-Booté…ç½®"><a href="#Spring-Booté…ç½®" class="headerlink" title="Spring Booté…ç½®"></a>Spring Booté…ç½®</h3><p>è¦äº†è§£spring data mongoåŸç†ï¼Œæœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯çœ‹repositoryæ˜¯æ€ä¹ˆåˆå§‹åŒ–çš„ï¼Œç”±äºè¯¥demoæ˜¯åŸºäºspring bootï¼ŒæŒ‰ç…§spring bootçš„ç‰¹ç‚¹ï¼Œåˆå§‹åŒ–çš„æ§åˆ¶éƒ½æ˜¯ç”±å„ç§AutoConfigurationå¼•å¯¼ã€‚</p>
<p>ç›´æ¥åœ¨IDEé‡Œæœç´¢ *Mongo*AutoConfiguration, å¯ä»¥å‘ç°ä»¥ä¸‹é…ç½®ç±»</p>
<h4 id="ç›¸å…³é…ç½®ç±»"><a href="#ç›¸å…³é…ç½®ç±»" class="headerlink" title="ç›¸å…³é…ç½®ç±»"></a>ç›¸å…³é…ç½®ç±»</h4><ul>
<li>org.springframework.boot.autoconfigure.mongoï¼ŒMongoClient,MongoTemplateç›¸å…³é…ç½®<img src="/2018/04/04/spring-data-mongoæºç è§£æ/pasted-0.png" title="example.jpg"></li>
<li>org.springframework.boot.autoconfigure.data.mongoï¼Œdata mongoç›¸å…³é…ç½®ï¼Œæ¶‰åŠåˆ°æ ¸å¿ƒç±»Repository<img src="/2018/04/04/spring-data-mongoæºç è§£æ/pasted-1.png" title="example.jpg">
</li>
</ul>
<p>spring data mongoä¸»è¦æ˜¯ç”±è¿™ä¸¤ä¸ªpackageä¸‹çš„é…ç½®ç±»åˆå§‹åŒ–,å¯¹äºRepositoryç±»çš„åˆå§‹åŒ–ï¼Œæ ¸å¿ƒç±»æ˜¯<br>MongoRepositoriesAutoConfigureRegistrar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoRepositoriesAutoConfigureRegistrar</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">AbstractRepositoryConfigurationSourceSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;? extends Annotation&gt; getAnnotation() &#123;</span><br><span class="line">		<span class="keyword">return</span> EnableMongoRepositories.class;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; getConfiguration() &#123;</span><br><span class="line">		<span class="keyword">return</span> EnableMongoRepositoriesConfiguration.class;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RepositoryConfigurationExtension <span class="title">getRepositoryConfigurationExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MongoRepositoryConfigurationExtension();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@EnableMongoRepositories</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableMongoRepositoriesConfiguration</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥ç±»ç»§æ‰¿äº†<strong>AbstractRepositoryConfigurationSourceSupport</strong>å¹¶ä¸”å®ç°äº†ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•ï¼ŒæŸ¥çœ‹äº†AbstractRepositoryConfigurationSourceSupportçš„å­ç±»ï¼Œå¯ä»¥å‘ç°spring dataå¾ˆå¤šæ¨¡å—éƒ½æ˜¯ç»§æ‰¿è¯¥ç±»ï¼Œæ‰€ä»¥<strong>AbstractRepositoryConfigurationSourceSupport</strong>æ˜¯Spring dataåˆå§‹åŒ–çš„æ ¸å¿ƒ</p>
<ul>
<li>AbstractRepositoryConfigurationSourceSupport<ul>
<li>CassandraRepositoriesAutoConfigureRegistrar </li>
<li>MongoRepositoriesAutoConfigureRegistrar </li>
<li>ElasticsearchRepositoriesRegistrar </li>
<li>LdapRepositoriesRegistrar </li>
<li>CassandraReactiveRepositoriesAutoConfigureRegistrar </li>
<li>CouchbaseRepositoriesRegistrar </li>
<li>JpaRepositoriesAutoConfigureRegistrar </li>
<li>CouchbaseReactiveRepositoriesRegistrar </li>
<li>RedisRepositoriesAutoConfigureRegistrar </li>
<li>Neo4jRepositoriesAutoConfigureRegistrar </li>
<li>SolrRepositoriesRegistrar </li>
<li>MongoReactiveRepositoriesAutoConfigureRegistrar</li>
</ul>
</li>
</ul>
<h4 id="MongoRepositoriesAutoConfigureRegistrar"><a href="#MongoRepositoriesAutoConfigureRegistrar" class="headerlink" title="MongoRepositoriesAutoConfigureRegistrar"></a>MongoRepositoriesAutoConfigureRegistrar</h4><p>è¯¥ç±»å®ç°çš„ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯è¿”å›äº†é…ç½®ç±»POJOï¼Œè¿™é‡Œä¸»è¦æœ‰ä¸¤ä¸ªå¯¹è±¡</p>
<ol>
<li>EnableMongoRepositories é…ç½®ç±»ï¼Œæ–¹æ³•getRepositoryFactoryBeanClassNameè¿”å›MongoRepositoryFactoryBeanï¼Œè¯¥å·¥å‚beanè¿”å›äº†Repositorydçš„ä»£ç†</li>
<li>RepositoryConfigurationExtension è¯¥ç±»ä¸»è¦æ˜¯åœ¨Spring Dataé€šç”¨çš„beanåˆå§‹åŒ–é˜¶æ®µåŠ å…¥mongodbç‰¹æœ‰çš„ä¸€äº›é…ç½®ï¼Œå…¶å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯æ¥å—äº†BeanDefinitionBuilderè¿›è¡Œä¸€äº›</li>
</ol>
<details><summary>EnableMongoRepositories</summary><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableMongoRepositories &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Alias for the &#123;<span class="doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation declarations e.g.:</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> <span class="doctag">@EnableMongoRepositories</span>("org.my.pkg")&#125; instead of &#123;<span class="doctag">@code</span> <span class="doctag">@EnableMongoRepositories</span>(basePackages="org.my.pkg")&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Base packages to scan for annotated components. &#123;<span class="doctag">@link</span> #value()&#125; is an alias for (and mutually exclusive with) this</span></span><br><span class="line"><span class="comment">	 * attribute. Use &#123;<span class="doctag">@link</span> #basePackageClasses()&#125; for a type-safe alternative to String-based package names.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Type-safe alternative to &#123;<span class="doctag">@link</span> #basePackages()&#125; for specifying the packages to scan for annotated components. The</span></span><br><span class="line"><span class="comment">	 * package of each class specified will be scanned. Consider creating a special no-op marker class or interface in</span></span><br><span class="line"><span class="comment">	 * each package that serves no purpose other than being referenced by this attribute.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Specifies which types are eligible for component scanning. Further narrows the set of candidate components from</span></span><br><span class="line"><span class="comment">	 * everything in &#123;<span class="doctag">@link</span> #basePackages()&#125; to everything in the base packages that matches the given filter or filters.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Filter[] includeFilters() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Specifies which types are not eligible for component scanning.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Filter[] excludeFilters() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the postfix to be used when looking up custom repository implementations. Defaults to &#123;<span class="doctag">@literal</span> Impl&#125;. So</span></span><br><span class="line"><span class="comment">	 * for a repository named &#123;<span class="doctag">@code</span> PersonRepository&#125; the corresponding implementation class will be looked up scanning</span></span><br><span class="line"><span class="comment">	 * for &#123;<span class="doctag">@code</span> PersonRepositoryImpl&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">repositoryImplementationPostfix</span><span class="params">()</span> <span class="keyword">default</span> "Impl"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configures the location of where to find the Spring Data named queries properties file. Will default to</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> META-INFO/mongo-named-queries.properties&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">namedQueriesLocation</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the key of the &#123;<span class="doctag">@link</span> QueryLookupStrategy&#125; to be used for lookup queries for query methods. Defaults to</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> Key#CREATE_IF_NOT_FOUND&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">Key <span class="title">queryLookupStrategy</span><span class="params">()</span> <span class="keyword">default</span> Key.CREATE_IF_NOT_FOUND</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the &#123;<span class="doctag">@link</span> FactoryBean&#125; class to be used for each repository instance. Defaults to</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> MongoRepositoryFactoryBean&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt; repositoryFactoryBeanClass() <span class="keyword">default</span> MongoRepositoryFactoryBean.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configure the repository base class to be used to create repository proxies for this particular configuration.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt; repositoryBaseClass() <span class="keyword">default</span> DefaultRepositoryBaseClass.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configures the name of the &#123;<span class="doctag">@link</span> MongoTemplate&#125; bean to be used with the repositories detected.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">mongoTemplateRef</span><span class="params">()</span> <span class="keyword">default</span> "mongoTemplate"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Whether to automatically create indexes for query methods defined in the repository interface.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">createIndexesForQueryMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configures whether nested repository-interfaces (e.g. defined as inner classes) should be discovered by the</span></span><br><span class="line"><span class="comment">	 * repositories infrastructure.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">considerNestedRepositories</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><p></p><br></details>

<details><summary>EnableMongoRepositoriesConfiguration</summary><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableMongoRepositories</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableMongoRepositoriesConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><p></p><br></details>

<details><summary>RepositoryConfigurationExtension</summary><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RepositoryConfigurationExtension</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the descriptive name of the module.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getModuleName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all &#123;<span class="doctag">@link</span> RepositoryConfiguration&#125;s obtained through the given &#123;<span class="doctag">@link</span> RepositoryConfigurationSource&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> configSource must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> loader must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@deprecated</span> call or implement</span></span><br><span class="line"><span class="comment">	 *             &#123;<span class="doctag">@link</span> #getRepositoryConfigurations(RepositoryConfigurationSource, ResourceLoader, boolean)&#125; instead.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	&lt;T extends RepositoryConfigurationSource&gt; Collection&lt;RepositoryConfiguration&lt;T&gt;&gt; getRepositoryConfigurations(</span><br><span class="line">			T configSource, ResourceLoader loader);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all &#123;<span class="doctag">@link</span> RepositoryConfiguration&#125;s obtained through the given &#123;<span class="doctag">@link</span> RepositoryConfigurationSource&#125;.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> configSource</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> loader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> strictMatchesOnly whether to return strict repository matches only. Handing in &#123;<span class="doctag">@literal</span> true&#125; will cause</span></span><br><span class="line"><span class="comment">	 *          the repository interfaces and domain types handled to be checked whether they are managed by the current</span></span><br><span class="line"><span class="comment">	 *          store.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.9</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	&lt;T extends RepositoryConfigurationSource&gt; Collection&lt;RepositoryConfiguration&lt;T&gt;&gt; getRepositoryConfigurations(</span><br><span class="line">			T configSource, ResourceLoader loader, <span class="keyword">boolean</span> strictMatchesOnly);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the default location of the Spring Data named queries.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> must not be &#123;<span class="doctag">@literal</span> null&#125; or empty.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getDefaultNamedQueryLocation</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the name of the repository factory class to be used.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getRepositoryFactoryBeanClassName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to register additional bean definitions for a &#123;<span class="doctag">@literal</span> repositories&#125; root node. This usually includes</span></span><br><span class="line"><span class="comment">	 * beans you have to set up once independently of the number of repositories to be created. Will be called before any</span></span><br><span class="line"><span class="comment">	 * repositories bean definitions have been registered.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> source</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerBeansForRoot</span><span class="params">(BeanDefinitionRegistry registry, RepositoryConfigurationSource configurationSource)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to post process the &#123;<span class="doctag">@link</span> BeanDefinition&#125; and tweak the configuration if necessary.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> config will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcess</span><span class="params">(BeanDefinitionBuilder builder, RepositoryConfigurationSource config)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to post process the &#123;<span class="doctag">@link</span> BeanDefinition&#125; built from annotations and tweak the configuration if</span></span><br><span class="line"><span class="comment">	 * necessary.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> config will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcess</span><span class="params">(BeanDefinitionBuilder builder, AnnotationRepositoryConfigurationSource config)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to post process the &#123;<span class="doctag">@link</span> BeanDefinition&#125; built from XML and tweak the configuration if necessary.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> builder will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> config will never be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcess</span><span class="params">(BeanDefinitionBuilder builder, XmlRepositoryConfigurationSource config)</span></span>;</span><br></pre></td></tr></table></figure><br><br><p></p><br></details>

<h3 id="åˆå§‹åŒ–æµç¨‹"><a href="#åˆå§‹åŒ–æµç¨‹" class="headerlink" title="åˆå§‹åŒ–æµç¨‹"></a>åˆå§‹åŒ–æµç¨‹</h3><h4 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h4><p>MongoRepositoriesAutoConfigureRegistrarçš„çˆ¶ç±»AbstractRepositoryConfigurationSourceSupport<br><strong>AbstractRepositoryConfigurationSourceSupport</strong>ï¼Œè¯¥ç±»ä¸»è¦å®ç°äº†<a href="https://github.com/spring-projects/spring-framework/blob/28b2a4d46db39f7c6c25ba8a4ace825af3c4cbcb/spring-context/src/main/java/org/springframework/context/annotation/ImportBeanDefinitionRegistrar.java#L61" target="_blank" rel="noopener">ImportBeanDefinitionRegistrar</a>çš„registerBeanDefinitionsæ–¹æ³•ï¼ŒregisterBeanDefinitionsæ˜¯Springåˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ï¼Œè®©ç¨‹åºèƒ½å¤Ÿè‡ªä¸»æ³¨å†Œä¸€äº›beanåˆ°springå®¹å™¨é‡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span></span></span><br><span class="line"><span class="function"><span class="params">		BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">new</span> RepositoryConfigurationDelegate(getConfigurationSource(registry),</span><br><span class="line">			<span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.environment).registerRepositoriesIn(registry,</span><br><span class="line">					getRepositoryConfigurationExtension());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h4><p>registerBeanDefinitions. registerBeanDefinitionsè°ƒç”¨äº†RepositoryConfigurationDelegate.registerRepositoriesInæ–¹æ³•<br>è¿™ä¸ªæ–¹æ³•åŒ…å«äº†spring data mongoå¯¹äºmongo repositoryçš„åˆå§‹åŒ–çš„æ•´ä¸ªæµç¨‹ï¼Œä¸»è¦é€»è¾‘æ˜¯é€šè¿‡configurationSourceï¼ˆç”±EnableMongoRepositoriesæ„é€ ï¼‰ï¼Œä»¥åŠRepositoryConfigurationExtensionæ‰«æBasePackagesä¸‹é¢çš„ç±»ï¼Œæ„é€ beanDefinitionå¹¶ä¸”æ³¨å†Œåˆ°spring registryã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers the found repositories in the given &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> extension</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> BeanComponentDefinition&#125;s for all repository bean definitions found.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BeanComponentDefinition&gt; <span class="title">registerRepositoriesIn</span><span class="params">(BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">		RepositoryConfigurationExtension extension)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	extension.registerBeansForRoot(registry, configurationSource);</span><br><span class="line"></span><br><span class="line">	RepositoryBeanDefinitionBuilder builder = <span class="keyword">new</span> RepositoryBeanDefinitionBuilder(registry, extension, resourceLoader,</span><br><span class="line">			environment);</span><br><span class="line">	List&lt;BeanComponentDefinition&gt; definitions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (RepositoryConfiguration&lt;? extends RepositoryConfigurationSource&gt; configuration : extension</span><br><span class="line">			.getRepositoryConfigurations(configurationSource, resourceLoader, inMultiStoreMode)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//BeanDefintionæ„é€ çš„ä¸»è¦é€»è¾‘</span></span><br><span class="line">		BeanDefinitionBuilder definitionBuilder = builder.build(configuration);</span><br><span class="line"></span><br><span class="line">		extension.postProcess(definitionBuilder, configurationSource);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isXml) &#123;</span><br><span class="line">			extension.postProcess(definitionBuilder, (XmlRepositoryConfigurationSource) configurationSource);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			extension.postProcess(definitionBuilder, (AnnotationRepositoryConfigurationSource) configurationSource);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		AbstractBeanDefinition beanDefinition = definitionBuilder.getBeanDefinition();</span><br><span class="line">		String beanName = configurationSource.generateBeanName(beanDefinition);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">			LOGGER.debug(REPOSITORY_REGISTRATION, extension.getModuleName(), beanName,</span><br><span class="line">					configuration.getRepositoryInterface(), configuration.getRepositoryFactoryBeanClassName());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		beanDefinition.setAttribute(FACTORY_BEAN_OBJECT_TYPE, configuration.getRepositoryInterface());</span><br><span class="line"></span><br><span class="line">		registry.registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">		definitions.add(<span class="keyword">new</span> BeanComponentDefinition(beanDefinition, beanName));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> definitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BeanDefinitionæ„é€ "><a href="#BeanDefinitionæ„é€ " class="headerlink" title="BeanDefinitionæ„é€ "></a>BeanDefinitionæ„é€ </h3><p>registerRepositoriesInè°ƒç”¨äº†RepositoryBeanDefinitionBuilder.buildæ–¹æ³•ï¼Œæ³¨æ„åˆ°BeanDefinitionBuilder<br>                .rootBeanDefinition(configuration.getRepositoryFactoryBeanClassName())ï¼Œè¿™é‡ŒæŠŠMongoRepositoryFactoryBeanè®¾ç½®ä¸ºBeanDefinitionçš„class,æ„å‘³ç€Beançš„åˆå§‹åŒ–ç”±MongoRepositoryFactoryBeanè¿›è¡Œæ§åˆ¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionBuilder <span class="title">build</span><span class="params">(RepositoryConfiguration&lt;?&gt; configuration)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.notNull(registry, <span class="string">"BeanDefinitionRegistry must not be null!"</span>);</span><br><span class="line">		Assert.notNull(resourceLoader, <span class="string">"ResourceLoader must not be null!"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//è®¾ç½®ç±»ä¸ºMongoRepositoryFactoryBean</span></span><br><span class="line">		BeanDefinitionBuilder builder = BeanDefinitionBuilder</span><br><span class="line">				.rootBeanDefinition(configuration.getRepositoryFactoryBeanClassName());</span><br><span class="line"></span><br><span class="line">		builder.getRawBeanDefinition().setSource(configuration.getSource());</span><br><span class="line">		builder.addConstructorArgValue(configuration.getRepositoryInterface());</span><br><span class="line">		builder.addPropertyValue(<span class="string">"queryLookupStrategyKey"</span>, configuration.getQueryLookupStrategyKey());</span><br><span class="line">		builder.addPropertyValue(<span class="string">"lazyInit"</span>, configuration.isLazyInit());</span><br><span class="line"></span><br><span class="line">		configuration.getRepositoryBaseClassName()<span class="comment">//</span></span><br><span class="line">				.ifPresent(it -&gt; builder.addPropertyValue(<span class="string">"repositoryBaseClass"</span>, it));</span><br><span class="line"></span><br><span class="line">		NamedQueriesBeanDefinitionBuilder definitionBuilder = <span class="keyword">new</span> NamedQueriesBeanDefinitionBuilder(</span><br><span class="line">				extension.getDefaultNamedQueryLocation());</span><br><span class="line">		configuration.getNamedQueriesLocation().ifPresent(definitionBuilder::setLocations);</span><br><span class="line"></span><br><span class="line">		builder.addPropertyValue(<span class="string">"namedQueries"</span>, definitionBuilder.build(configuration.getSource()));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//2.0ç‰ˆæœ¬å·²ç»ä¸å»ºè®®ä½¿ç”¨çš„æ–¹æ³•ï¼Œå’ŒFramementç±»ä¼¼</span></span><br><span class="line">		registerCustomImplementation(configuration).ifPresent(it -&gt; &#123;</span><br><span class="line">			builder.addPropertyReference(<span class="string">"customImplementation"</span>, it);</span><br><span class="line">			builder.addDependsOn(it);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		BeanDefinitionBuilder fragmentsBuilder = BeanDefinitionBuilder</span><br><span class="line">				.rootBeanDefinition(RepositoryFragmentsFactoryBean.class);</span><br><span class="line"></span><br><span class="line">		List&lt;String&gt; fragmentBeanNames = registerRepositoryFragmentsImplementation(configuration) <span class="comment">//</span></span><br><span class="line">				.map(RepositoryFragmentConfiguration::getFragmentBeanName) <span class="comment">//</span></span><br><span class="line">				.collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">		fragmentsBuilder.addConstructorArgValue(fragmentBeanNames);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//æ³¨å†ŒFragmemnt,ä¹Ÿå°±æ˜¯è¿™ç§åšæ³•</span></span><br><span class="line">		<span class="comment">//https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#repositories.custom-implementations</span></span><br><span class="line">		builder.addPropertyValue(<span class="string">"repositoryFragments"</span>,</span><br><span class="line">				ParsingUtils.getSourceBeanDefinition(fragmentsBuilder, configuration.getSource()));</span><br><span class="line"></span><br><span class="line">		RootBeanDefinition evaluationContextProviderDefinition = <span class="keyword">new</span> RootBeanDefinition(</span><br><span class="line">				ExtensionAwareEvaluationContextProvider.class);</span><br><span class="line">		evaluationContextProviderDefinition.setSource(configuration.getSource());</span><br><span class="line"></span><br><span class="line">		builder.addPropertyValue(<span class="string">"evaluationContextProvider"</span>, evaluationContextProviderDefinition);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> builder;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MongoRepositoryFactoryBean"><a href="#MongoRepositoryFactoryBean" class="headerlink" title="MongoRepositoryFactoryBean"></a>MongoRepositoryFactoryBean</h3><p>MongoRepositoriesAutoConfigureRegistrarçš„èŒè´£æœ€ç»ˆå°±æ˜¯æŠŠæ‰€æœ‰æ‰«åˆ°çš„Repositoryæ„é€ æˆBeanDefinitionæ³¨å†Œåˆ°Registry, BeanDefinitionçš„BaseClassæ˜¯MongoRepositoryFactoryBeanï¼Œæ‰€ä»¥è¯¥FactoryBeanæ˜¯spring data mongoçš„æ ¸å¿ƒã€‚</p>
<p>ä»è¯¥Sequence Diagramå¯ä»¥çœ‹å‡ºRepositoryæœ€ç»ˆçš„å®ç°æ˜¯é€šè¿‡Proxy,è¿™é‡Œåªåˆ—å‡ºäº†ä¸¤ä¸ªå…³é”®çš„Interceptor</p>
<ol>
<li>QueryExecutorMethodInterceptor - è¯¥ç±»ä¸»è¦å®ç°äº†<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#mongodb.repositories.queries" target="_blank" rel="noopener">Query methods</a></li>
<li>ImplementationMethodExecutionInterceptor - è¯¥ç±»ä¸»è¦å®ç°äº†<a href="https://docs.spring.io/spring-data/mongodb/docs/2.0.6.RELEASE/reference/html/#repositories.custom-implementations" target="_blank" rel="noopener">repositories.custom-implementations</a></li>
</ol>
<p><strong>Sequence Diagram</strong></p>
<img src="http://www.plantuml.com/plantuml/svg/dP5D2eCm48NtdYBBTk45f1HgQS65q9yJ3F7L1ZG9oTZgxHkHKalHWgkGcNdVuyrOSgoaigHPv4QNvW9hl6BZkYF9_ab1EegcUoBUpYWJGJU6EpbZ4PpWh-18EX1ZGhN8AX4QpuLA3_vKK_BOL-JzGbWvXhs3XlJjdtWzSpms5-XtbefYLpoKnEhSm7M75h89dHnyDqMcmm4aR2Yi5n2psbQeePbO6JqW1uFm_MBFhMmJnvCx6oti1G00">
<p><strong>Class Diagram</strong></p>
<img src="http://www.plantuml.com/plantuml/svg/ZP193e8m58RNzXJT6pY22nDDM1372zJwm1fec_988CZTBKCK1QfB_kcLZmY9O2B6WMuPHsNADJ19UCAoZ8PAnke8McMYSSQ1IU-KQwqCqeeigaX0SgsfTwRc5RLo2dXJLb-oo5xV6wN1e83i13XqppG6t5tkm97KpZVrfbqglgH33gRS5C1pAuRjSj3yCWTjXJuKf3g152Go54fsgQvZFuVnDwtn59d7HJtliNBI8awKlc_hG_m_qgivJDDos_XWvyZz0Efe_atPVQAZCRxyx_nS_ma0">
<h3 id="QueryExecutorMethodInterceptor"><a href="#QueryExecutorMethodInterceptor" class="headerlink" title="QueryExecutorMethodInterceptor"></a>QueryExecutorMethodInterceptor</h3><p>ä»è¯¥Sequence Diagramå¯çœ‹å‡ºQueryExecutorMethodInterceptoræœ€ç»ˆæ„é€ äº†PartTreeï¼ŒPartTreeåˆPredicateç»„æˆ</p>
<h4 id="Sequence-Diagram"><a href="#Sequence-Diagram" class="headerlink" title="Sequence Diagram"></a>Sequence Diagram</h4><img src="http://www.plantuml.com/plantuml/svg/umeiJIsgTAr8JIujoI_oJIt9o4_np2j9BKfEBG0AAEZQAVZcvwNdWvNvvETdbnO4bnGbbgIcLreLfHRdvvIbWgMuaejIWQ8A0Ob59I55gQa8JLouz8FCnbHkfP2NMevk6XUcEcJTg7gAKbCoau4ik2QmKfWeH2q0">
<h4 id="Class-Diagram"><a href="#Class-Diagram" class="headerlink" title="Class Diagram"></a>Class Diagram</h4><img src="http://www.plantuml.com/plantuml/svg/XP3D3i8W48JlF0Ld3po01suUJ6pyVG52rqeqNRA5n2O-l2sKrYYjjs6OcKq-KpkWgzB0ZnwetI7UlJqxKWwgbkc7QXfUO5rXxjkCvHDOR8n3QaDkA1uKkGi1J0CVbGBS3Sjj_zPWk-fG2hdD4xJllBbGMcRBQIx4IsOk_Mt970xEvaZ4Epb4lmXYzXlOmhBCSSpiheIOk2GHNOBIw6wFZIhuU-fZVCrhDiYq4Rmt">
<h3 id="PartTree"><a href="#PartTree" class="headerlink" title="PartTree"></a>PartTree</h3><p><a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L84" target="_blank" rel="noopener">PartTree</a>é¦–å…ˆé€šè¿‡æ–¹æ³•å(sourceå‚æ•°)è§£æå‡ºè¯­å¥ç±»å‹ï¼ˆæŸ¥è¯¢/æ›´æ–°/åˆ é™¤ï¼‰ï¼Œç„¶åæŠŠä½™ä¸‹çš„éƒ¨åˆ†ä¼ ç»™äº†Predicate, ä¾‹å¦‚findByAuthorOrTitle(ä»¥ä¸‹çš„è§£ææŠŠè¿™ä¸ªæ–¹æ³•åä½œä¸ºä¾‹å­ï¼‰ï¼Œé‚£ä¹ˆä¼ ç»™Predicateçš„å°±æ˜¯<strong>AuthorOrTitle</strong></p>
<p>ä¸‹é¢è¿™äº›é™æ€å˜é‡åˆ™æ˜¯å®šä¹‰äº†åˆæ³•çš„æ–¹æ³•åå‰ç¼€ï¼Œä»è¿™äº›å˜é‡å¯çŸ¥é“æŸ¥è¯¢æ–¹æ³•çš„å‰ç¼€ä¸ä»…ä»…åªæ”¯æŒâ€œfindâ€,ğŸ˜ŠåŒæ—¶ä¹Ÿæ”¯æŒâ€œread/get/query/steamâ€.è¿™äº›å¯åœ¨å®˜æ–¹æ–‡æ¡£æ²¡æåŠã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEYWORD_TEMPLATE = <span class="string">"(%s)(?=(\\p&#123;Lu&#125;|\\P&#123;InBASIC_LATIN&#125;))"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUERY_PATTERN = <span class="string">"find|read|get|query|stream"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COUNT_PATTERN = <span class="string">"count"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXISTS_PATTERN = <span class="string">"exists"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELETE_PATTERN = <span class="string">"delete|remove"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PREFIX_TEMPLATE = Pattern.compile( <span class="comment">//</span></span><br><span class="line">		<span class="string">"^("</span> + QUERY_PATTERN + <span class="string">"|"</span> + COUNT_PATTERN + <span class="string">"|"</span> + EXISTS_PATTERN + <span class="string">"|"</span> + DELETE_PATTERN + <span class="string">")((\\p&#123;Lu&#125;.*?))??By"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PartTree</span><span class="params">(String source, Class&lt;?&gt; domainClass)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Assert.notNull(source, <span class="string">"Source must not be null"</span>);</span><br><span class="line">	Assert.notNull(domainClass, <span class="string">"Domain class must not be null"</span>);</span><br><span class="line"></span><br><span class="line">	Matcher matcher = PREFIX_TEMPLATE.matcher(source);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!matcher.find()) &#123;</span><br><span class="line">		<span class="keyword">this</span>.subject = <span class="keyword">new</span> Subject(Optional.empty());</span><br><span class="line">		<span class="keyword">this</span>.predicate = <span class="keyword">new</span> Predicate(source, domainClass);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.subject = <span class="keyword">new</span> Subject(Optional.of(matcher.group(<span class="number">0</span>)));</span><br><span class="line">		<span class="keyword">this</span>.predicate = <span class="keyword">new</span> Predicate(source.substring(matcher.group().length()), domainClass);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h3><p>é‚£ä¹ˆ<a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L361" target="_blank" rel="noopener">Predicate</a>çš„é€»è¾‘åˆæ˜¯æ€æ ·çš„å‘¢ï¼ŸPredicateä¸»è¦æ˜¯æ ¹æ®repositoryçš„æ–¹æ³•åï¼Œé€šè¿‡å…³é”®å­—â€œOrâ€ï¼ŒæŠŠæ–¹æ³•åsplitæˆå¤šä¸ªå­å­—ç¬¦ä¸²ï¼Œæ„é€ OrPart, å¤šä¸ªOrPartæœ€ç»ˆåœ¨mongoçš„æŸ¥è¯¢é‡Œå°±ä¼šè§£ææˆäº†$or.ä¾‹å¦‚<strong>AuthorOrTitle</strong>å°±ä¼šè¢«æ‹†æˆ<strong>Author</strong>å’Œ<strong>Title</strong>ç„¶åæ„é€ æˆä¸¤ä¸ªOrPartå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Predicate</span><span class="params">(String predicate, Class&lt;?&gt; domainClass)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String[] parts = split(detectAndSetAllIgnoreCase(predicate), ORDER_BY);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (parts.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"OrderBy must not be used more than once in a method name!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.nodes = Arrays.stream(split(parts[<span class="number">0</span>], <span class="string">"Or"</span>)) <span class="comment">//</span></span><br><span class="line">			.filter(StringUtils::hasText) <span class="comment">//</span></span><br><span class="line">			.map(part -&gt; <span class="keyword">new</span> OrPart(part, domainClass, alwaysIgnoreCase)) <span class="comment">//</span></span><br><span class="line">			.collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.orderBySource = parts.length == <span class="number">2</span> ? <span class="keyword">new</span> OrderBySource(parts[<span class="number">1</span>], Optional.of(domainClass))</span><br><span class="line">					: OrderBySource.EMPTY;</span><br></pre></td></tr></table></figure>
<h3 id="OrPart"><a href="#OrPart" class="headerlink" title="OrPart"></a>OrPart</h3><p>ä»<a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/PartTree.java#L233" target="_blank" rel="noopener">OrPart</a>çš„æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œæ˜¯æŠŠSourceæ‹†æˆæ„é€ æˆList\&lt;Part>,ä»¥<strong>Author</strong>ä½œä¸ºä¾‹å­ï¼Œç”±äºä¹Ÿä¸åŒ…å«â€Andâ€,æ‰€ä»¥åªä¼šæœ‰ä¸€ä¸ªPartå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OrPart(String source, Class&lt;?&gt; domainClass, <span class="keyword">boolean</span> alwaysIgnoreCase) &#123;</span><br><span class="line"></span><br><span class="line">	String[] split = split(source, <span class="string">"And"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.children = Arrays.stream(split)<span class="comment">//</span></span><br><span class="line">			.filter(StringUtils::hasText)<span class="comment">//</span></span><br><span class="line">			.map(part -&gt; <span class="keyword">new</span> Part(part, domainClass, alwaysIgnoreCase))<span class="comment">//</span></span><br><span class="line">			.collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Part"><a href="#Part" class="headerlink" title="Part"></a>Part</h3><p><a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/Part.java#L69" target="_blank" rel="noopener">Part</a>ä¸»è¦è®¾ç½®äº†ä¸¤ä¸ªæˆå‘˜å˜é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Part</span><span class="params">(String source, Class&lt;?&gt; clazz, <span class="keyword">boolean</span> alwaysIgnoreCase)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.hasText(source, <span class="string">"Part source must not be null or empty!"</span>);</span><br><span class="line">		Assert.notNull(clazz, <span class="string">"Type must not be null!"</span>);</span><br><span class="line"></span><br><span class="line">		String partToUse = detectAndSetIgnoreCase(source);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (alwaysIgnoreCase &amp;&amp; ignoreCase != IgnoreCaseType.ALWAYS) &#123;</span><br><span class="line">			<span class="keyword">this</span>.ignoreCase = IgnoreCaseType.WHEN_POSSIBLE;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.type = Type.fromProperty(partToUse);</span><br><span class="line">		<span class="keyword">this</span>.propertyPath = PropertyPath.from(type.extractProperty(partToUse), clazz);</span><br><span class="line">	&#125;</span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. [type](https:<span class="comment">//github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/query/parser/Part.java#L149) - ä¸»è¦ä¿å­˜äº†è¯¥æ¡ä»¶çš„ç±»å‹ï¼ŒBETWEEN, IS_NOT_NULLç­‰ç­‰ï¼Œ å¯¹äºä¾‹å­ä¸­çš„**author**å…³é”®å­—ï¼Œåˆ™ä¼šè§£æä¸ºType.SIMPLE_PROPERTY,è¡¨ç¤ºEQUAL.</span></span><br><span class="line"><span class="number">2</span>. propertyPath - å±æ€§åï¼Œ **author**</span><br><span class="line"></span><br><span class="line">**çœ‹åˆ°è¿™é‡Œï¼Œåˆå§‹åŒ–çš„é€»è¾‘åŸºæœ¬å®Œæ¯•ï¼Œ Repositoryçš„æ–¹æ³•æœ€ç»ˆä¼šè¢«è§£æå¹¶ä¸”ä¿å­˜æˆPartTree, æŸ¥è¯¢çš„æ—¶å€™åªéœ€è¦ä»PartTreeç”Ÿæˆmongoè¯­å¥**</span><br><span class="line"></span><br><span class="line">### MongoQueryCreator</span><br><span class="line">[MongoQueryCreator](https:<span class="comment">//github.com/spring-projects/spring-data-mongodb/blob/17d61004261c388a98bf1cc932318db69073db2f/spring-data-mongodb/src/main/java/org/springframework/data/mongodb/repository/query/MongoQueryCreator.java#L174)ä»è¯¥æ–¹æ³•å¯çœ‹å‡ºä»Partæ„å»ºå‡ºCriteriaçš„è¿‡ç¨‹ã€‚</span></span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="function"><span class="keyword">private</span> Criteria <span class="title">from</span><span class="params">(Part part, MongoPersistentProperty property, Criteria criteria, Iterator&lt;Object&gt; parameters)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Type type = part.getType();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (type) &#123;</span><br><span class="line">		<span class="keyword">case</span> AFTER:</span><br><span class="line">		<span class="keyword">case</span> GREATER_THAN:</span><br><span class="line">			<span class="keyword">return</span> criteria.gt(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> GREATER_THAN_EQUAL:</span><br><span class="line">			<span class="keyword">return</span> criteria.gte(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> BEFORE:</span><br><span class="line">		<span class="keyword">case</span> LESS_THAN:</span><br><span class="line">			<span class="keyword">return</span> criteria.lt(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> LESS_THAN_EQUAL:</span><br><span class="line">			<span class="keyword">return</span> criteria.lte(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> BETWEEN:</span><br><span class="line">			<span class="keyword">return</span> criteria.gt(parameters.next()).lt(parameters.next());</span><br><span class="line">		<span class="keyword">case</span> IS_NOT_NULL:</span><br><span class="line">			<span class="keyword">return</span> criteria.ne(<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">case</span> IS_NULL:</span><br><span class="line">			<span class="keyword">return</span> criteria.is(<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">case</span> NOT_IN:</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ol>
<li>æ‰«æè·¯å¾„ä¸‹ç»§æ‰¿Repositoryçš„æ¥å£ï¼ˆå½“æœ‰å¤šä¸ªspring dataæ¨¡å—å­˜åœ¨æ—¶ï¼Œåˆ™ä¼šé™å®šåˆ°MongoRepository)çš„ç±»ç”Ÿæˆä»£ç†ã€‚</li>
<li>è§£ææ¥å£åç”ŸæˆPartTree,æ‰§è¡Œçš„æ—¶å€™æ ¹æ®å¯¹åº”PartTreeç”ŸæˆCriteriaæ¡ä»¶ï¼Œä¼ ç»™MongoTemplate.</li>
</ol>
<h1 id="å½©è›‹"><a href="#å½©è›‹" class="headerlink" title="å½©è›‹"></a>å½©è›‹</h1><ol>
<li>ğŸ˜†çœ‹æºç è¿‡ç¨‹ä¸­å‘ç°<a href="https://github.com/spring-projects/spring-data-commons/blob/70ac316b400937d7e1dff71c1605a4205fc818bd/src/main/java/org/springframework/data/repository/core/support/SurroundingTransactionDetectorMethodInterceptor.java#L35" target="_blank" rel="noopener">SurroundingTransactionDetectorMethodInterceptor</a>æšä¸¾ç±»å¯ç»§æ‰¿æ¥å£ </li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/Druidè¿æ¥æ± è·å–è¶…æ—¶é—®é¢˜è§£å†³/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/Druidè¿æ¥æ± è·å–è¶…æ—¶é—®é¢˜è§£å†³/" itemprop="url">Druidè¿æ¥æ± è·å–è¶…æ—¶é—®é¢˜è§£å†³</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-04-03T08:45:02+08:00">
                2018-04-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/03/Druidè¿æ¥æ± è·å–è¶…æ—¶é—®é¢˜è§£å†³/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/03/Druidè¿æ¥æ± è·å–è¶…æ—¶é—®é¢˜è§£å†³/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>çº¿ä¸ŠæŸå°æœºå™¨å‡ºç°é¢‘ç¹çš„è·å–mysqlè¿æ¥è¶…æ—¶</p>
<h2 id="æ’æŸ¥æ­¥éª¤"><a href="#æ’æŸ¥æ­¥éª¤" class="headerlink" title="æ’æŸ¥æ­¥éª¤"></a>æ’æŸ¥æ­¥éª¤</h2><ol>
<li><p>é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹å‡ºæœåŠ¡æ—¶è·å–è¿æ¥æ± è¶…æ—¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2017-07-14 13:10:01,973 [DubboServerHandler-10.25.65.225:20900-thread-174] ERROR com.alibaba.dubbo.rpc.filter.ExceptionFilter (ExceptionFilter.java:87) -  [DUBBO] Got unchecked and undeclared exception which called by 10.25.68.15. service: com.bilin.user.dynamic.service.IUserDynamicService, method: queryNewestDynamicMsgByUser, exception: org.springframework.jdbc.CannotGetJdbcConnectionException: Could not get JDBC Connection; nested exception is com.alibaba.druid.pool.GetConnectionTimeoutException: wait millis 10000, active 0, dubbo version: 2.4.9, current host: 10.25.65.225</span><br><span class="line">org.springframework.jdbc.CannotGetJdbcConnectionException: Could not get JDBC Connection; nested exception is com.alibaba.druid.pool.GetConnectionTimeoutException: wait millis 10000, active 0</span><br><span class="line">        at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:82)</span><br><span class="line">        at org.springframework.orm.ibatis.SqlMapClientTemplate.execute(SqlMapClientTemplate.java:183)</span><br><span class="line">        at org.springframework.orm.ibatis.SqlMapClientTemplate.executeWithListResult(SqlMapClientTemplate.java:220)</span><br><span class="line">        at org.springframework.orm.ibatis.SqlMapClientTemplate.queryForList(SqlMapClientTemplate.java:267)</span><br><span class="line">        at com.bilin.sdk.dao.base.BaseDAO.queryForList(BaseDAO.java:27)</span><br><span class="line">Caused by: com.alibaba.druid.pool.GetConnectionTimeoutException: wait millis 10000, active 0</span><br><span class="line">        at com.alibaba.druid.pool.DruidDataSource.getConnectionInternal(DruidDataSource.java:1071)</span><br><span class="line">        at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:898)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:4544)</span><br><span class="line">        at com.alibaba.druid.filter.stat.StatFilter.dataSource_getConnection(StatFilter.java:661)</span><br></pre></td></tr></table></figure>
</li>
<li><p>çŒœæµ‹å¯èƒ½çš„åŸå› </p>
<ul>
<li>å¹¶å‘é‡å¤ªé«˜<br>ä»æ•°æ®ä¸Šçœ‹ï¼Œæ¯ç§’ä¸åˆ°1kè¯·æ±‚ï¼Œåç«¯mysqlæœåŠ¡å™¨çš„è´Ÿè½½ä¹Ÿä¸é«˜ï¼Œæ‰€ä»¥è¿™ä¸ªåŸå› åŸºæœ¬æ’é™¤</li>
<li>è¿æ¥æ± è¿æ¥æ•°è®¾ç½®è¿‡ä½<br>ä¸šåŠ¡è®¾ç½®çš„minIdel 100, maxConnection 300, æ‰€ä»¥è¿™ä¸ªåŸå› åŸºæœ¬æ’é™¤ã€‚</li>
<li>mysqlæœåŠ¡æ•…éšœ<br>éƒ¨ç½²åœ¨åˆ«çš„æœºå™¨ä¸Šçš„æœåŠ¡ï¼Œè¿˜æœ‰ä½¿ç”¨åŒä¸€ä¸ªdbå®ä¾‹çš„å…¶å®ƒä¸šåŠ¡æ²¡å‡ºç°å¼‚å¸¸æƒ…å†µï¼Œæ‰€ä»¥è¿™åŸå› æ¦‚ç‡ä¸å¤§</li>
<li>mysqlé“¾æ¥è®¾ç½®è¿‡ä½</li>
</ul>
</li>
<li><p>ç”±äºæ²¡æœ‰æ¯”è¾ƒæ˜æ˜¾çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥åªèƒ½çœ‹ä¸‹æºç (ç‰ˆæœ¬1.0.5)æ‰¾ä¸‹å…·ä½“çš„åŸå› ã€‚<br><a href="https://github.com/alibaba/druid/blob/1.0.5/src/main/java/com/alibaba/druid/pool/DruidDataSource.java" target="_blank" rel="noopener">DruidDataSource</a><br>å¼‚å¸¸çš„æŠ›å‡ºæ˜¯åœ¨1071è¡Œ<br><a href="https://github.com/alibaba/druid/blob/1.0.5/src/main/java/com/alibaba/druid/pool/DruidDataSource.java#L1071" target="_blank" rel="noopener">throw new GetConnectionTimeoutException(errorMessage);</a><br>ç”±äºè®¾ç½®äº†é“¾æ¥è·å–çš„è¶…æ—¶æ—¶é—´</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"10000"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ç”±æŠ¥é”™çš„æ—¥å¿—å¯çŸ¥ï¼Œè¿æ¥ç­‰å¾…äº†10ç§’è·å–å¤±è´¥ï¼Œæ‰€ä»¥å¯å¾—çŸ¥æ‰§è¡Œçš„æ–¹æ³•æ—¶pollLast</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (maxWait &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    holder = pollLast(nanos); <span class="comment">//L 1021</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    holder = takeLast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>druidçš„è¿æ¥è·å–ï¼Œæ˜¯é€šè¿‡notEmptyå’Œemptyä¸¤ä¸ªå˜é‡åè°ƒçº¿ç¨‹çš„åŒæ­¥ï¼ŒpollLastå‘ç°æ²¡å¯ç”¨è¿æ¥æ—¶ï¼Œå°±ä¼šnotEmpty.await(),åŒæ—¶empty.signal().  emtpy.signalä¸»è¦å”¤é†’äº†CreateConnectionThread. é€šè¿‡äº†è§£CreateConnectionThreadçš„æºç ï¼Œå‘ç°åœ¨æŸäº›æƒ…å†µä¸‹çº¿ç¨‹ä¼šé€€å‡ºã€‚<br><strong>æƒ…å†µ1</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    connection = createPhysicalConnection();</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"create connection error"</span>, e);</span><br><span class="line"></span><br><span class="line">    errorCount++;</span><br><span class="line">    <span class="comment">//å½“é”™è¯¯æ¬¡æ•°è¾¾åˆ°è®¾ç½®å€¼æ—¶ï¼ŒbreakAfterAcquireFailureè®¾ç½®ä¸ºtrueæ—¶çº¿ç¨‹ä¼šé€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (errorCount &gt; connectionErrorRetryAttempts &amp;&amp; timeBetweenConnectErrorMillis &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (breakAfterAcquireFailure) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(timeBetweenConnectErrorMillis);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException interruptEx) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"create connection error"</span>, e);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Error e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"create connection error"</span>, e);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>æƒ…å†µ2</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DruidConnectionHolder holder = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    holder = <span class="keyword">new</span> DruidConnectionHolder(DruidDataSource.<span class="keyword">this</span>, connection);</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œä¹Ÿä¼šé€€å‡º</span></span><br><span class="line">    LOG.error(<span class="string">"create connection holder error"</span>, ex);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æƒ…å†µ1ç”±äºåœ¨è¯¥é¡¹ç›®ä¸­æ²¡è®¾ç½®breakAfterAcquireFailureï¼Œé‡‡ç”¨é»˜è®¤å€¼false,æ‰€ä»¥æƒ…å†µ1ä¸å¤§å¯èƒ½å‡ºç°ï¼ŒErrorå±äºä¸å¯æ¢å¤é”™è¯¯ï¼Œæ‰€ä»¥é€€å‡ºä¹Ÿåˆç†ã€‚<br>æƒ…å†µ2å°±æœ‰ç‚¹ä¸åˆç†ï¼Œå•ä¸ªçš„SQLExceptionä¹Ÿä¼šå¯¼è‡´æ•´ä¸ªçš„ç”Ÿå­˜çº¿ç¨‹ç»“æŸã€‚</p>
<ol start="4">
<li>æ‰€ä»¥æ¥ä¸‹æ¥ä¸»è¦æ˜¯ç¡®è®¤CreateConnectionThreadæ˜¯å¦å­˜åœ¨å¼‚å¸¸<br>é€šè¿‡jstack grepçº¿ç¨‹åDruid-ConnectionPool-Createï¼ˆçº¿ç¨‹æœ‰è®¾ç½®çº¿ç¨‹åæ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼‰,ä»grepçš„ç»“æœï¼Œå‘ç°å­˜åœ¨ä¸€ä¸ªCreateConnectionThreadï¼Œç”±äºä¸šåŠ¡è®¾ç½®äº†ä¸¤ä¸ªè¿æ¥æ± ï¼Œæ‰€ä»¥ä¸€ä¸ªæ˜¯ä¸æ­£å¸¸<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo -u www-data jstack 10750  | grep "Druid-ConnectionPool-Create"</span></span><br><span class="line"><span class="string">"Druid-ConnectionPool-Create-376416626"</span> daemon prio=10 tid=0x00007faab4039800 nid=0x2ae3 waiting on condition [0x00007faac3ec6000]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ç»§ç»­grepä¸€ä¸‹Destroyçº¿ç¨‹ï¼Œç¡®è®¤æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥Destroyçº¿ç¨‹æ­£å¸¸ï¼Œè¿›ä¸€æ­¥ç¡®è®¤äº†CreateConnectionThreadçº¿ç¨‹å­˜åœ¨é—®é¢˜ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo -u www-data jstack 10750  | grep "Druid-ConnectionPool-Des"</span></span><br><span class="line"><span class="string">"Druid-ConnectionPool-Destory-376416626"</span> daemon prio=10 tid=0x00007faab403a800 nid=0x2ae4 waiting on condition [0x00007faac3e85000]</span><br><span class="line"><span class="string">"Druid-ConnectionPool-Destory-190586441"</span> daemon prio=10 tid=0x00007faad8fb1800 nid=0x2a3d waiting on condition [0x00007faac9dda000]</span><br></pre></td></tr></table></figure></p>
<ol start="5">
<li><p>åŸºæœ¬ç¡®è®¤äº†æ˜¯ç”±äºCreateConnectionThreadä¸æ­£å¸¸ç»“æŸï¼Œæ‰€ä»¥æœ€åä¸€æ­¥å°±æ˜¯æ‰¾å¯»è¯æ®è¯æ˜çº¿ç¨‹ä¸æ­£å¸¸çš„ç»“æŸã€‚é€šè¿‡ä»¥ä¸Šæºç ï¼Œå¯çœ‹åˆ°Druidåœ¨æ¯ä¸€æ­¥çš„å¼‚å¸¸å¤„ç†éƒ½ä¼šè®°å½•æ—¥å¿—ï¼Œæ‰€ä»¥é€šè¿‡æ—¥å¿—å…³é”®å­—è¿›è¡Œgrep,å‘ç°åœ¨1682è¡Œå†™äº†ä¸ªé”™è¯¯æ—¥å¿—ï¼Œ<strong>å¯¹åº”åˆ°çš„æ­£å¼çº¿ç¨‹é€€å‡ºæƒ…å†µ2</strong>.æ‰€ä»¥é—®é¢˜çš„åŸå› å°±æ˜¯druidåœ¨è·å–mysqlè¿æ¥ååˆ›å»ºDruidConnectionHolderæ—¶ç”±äºç½‘ç»œåŸå› æŠ¥äº†MySQLExceptionå¯¼è‡´äº†CreateConnectionThreadé€€å‡ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">2017-07-14 00:26:59,609 [Druid-ConnectionPool-Create-190586441] ERROR com.alibaba.druid.pool.DruidDataSource<span class="variable">$CreateConnectionThread</span> (DruidDataSource.java:1682) - create connection holder error</span><br><span class="line">com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure</span><br><span class="line">The last packet successfully received from the server was 0 milliseconds ago.  The last packet sent successfully to the server was 0 milliseconds ago.</span><br><span class="line">        at sun.reflect.GeneratedConstructorAccessor33.newInstance(Unknown Source)</span><br><span class="line">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">        at java.lang.reflect.Constructor.newInstance(Constructor.java:525)</span><br><span class="line">        at com.mysql.jdbc.Util.handleNewInstance(Util.java:411)</span><br><span class="line">        at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:1121)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3673)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3562)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4113)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2570)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2731)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2812)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2761)</span><br><span class="line">        at com.mysql.jdbc.StatementImpl.executeQuery(StatementImpl.java:1612)</span><br><span class="line">        at com.mysql.jdbc.ConnectionImpl.getTransactionIsolation(ConnectionImpl.java:3352)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.connection_getTransactionIsolation(FilterChainImpl.java:347)</span><br><span class="line">        at com.alibaba.druid.filter.FilterAdapter.connection_getTransactionIsolation(FilterAdapter.java:872)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.connection_getTransactionIsolation(FilterChainImpl.java:344)</span><br><span class="line">        at com.alibaba.druid.filter.FilterAdapter.connection_getTransactionIsolation(FilterAdapter.java:872)</span><br><span class="line">        at com.alibaba.druid.filter.FilterChainImpl.connection_getTransactionIsolation(FilterChainImpl.java:344)</span><br><span class="line">        at com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl.getTransactionIsolation(ConnectionProxyImpl.java:260)</span><br><span class="line">        at com.alibaba.druid.pool.DruidConnectionHolder.&lt;init&gt;(DruidConnectionHolder.java:92)</span><br><span class="line">        at com.alibaba.druid.pool.DruidDataSource<span class="variable">$CreateConnectionThread</span>.run(DruidDataSource.java:1680)</span><br><span class="line">Caused by: java.net.SocketException: Connection reset</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:189)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:121)</span><br><span class="line">        at com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:114)</span><br><span class="line">        at com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:161)</span><br><span class="line">        at com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:189)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:3116)</span><br><span class="line">        at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:3573)</span><br><span class="line">        ... 16 more</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥çœ‹äº†æœ€æ–°ç‰ˆæœ¬1.1.2è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œå‘ç°è¿™éƒ¨åˆ†ä»£ç å·²ç»é‡æ„äº†ï¼Œä¸å­˜åœ¨è¯¥é—®é¢˜ï¼Œæ‰€ä»¥å‡çº§ç‰ˆæœ¬å³å¯ã€‚</p>
</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>æ•…éšœçš„ç‰ˆæœ¬æ—¶1.0.5ï¼Œå‘å¸ƒäº2014å¹´ï¼Œå±äºæ¯”è¾ƒæ—§çš„ç‰ˆæœ¬ï¼Œå¼€æºå·¥å…·ä¸å¯é¿å…çš„ä¼šå­˜åœ¨bug,æ‰€ä»¥éœ€è¦å³æ—¶çš„è¿›è¡Œå‡çº§</li>
<li>ä½¿ç”¨å¼€æºå·¥å…·æ—¶ï¼Œå°½å¯èƒ½çš„ä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬ã€‚</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/02/å¦‚ä½•é€šè¿‡hexoæ•´åˆgithubpageæ­å»ºblog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HongShuwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/02/å¦‚ä½•é€šè¿‡hexoæ•´åˆgithubpageæ­å»ºblog/" itemprop="url">å¦‚ä½•é€šè¿‡hexoæ­å»ºblog</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-04-02T12:59:31+08:00">
                2018-04-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/02/å¦‚ä½•é€šè¿‡hexoæ•´åˆgithubpageæ­å»ºblog/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/02/å¦‚ä½•é€šè¿‡hexoæ•´åˆgithubpageæ­å»ºblog/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">HongShuwei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HongShuwei</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://hoswey.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
